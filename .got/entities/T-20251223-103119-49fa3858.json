{
  "_checksum": "46077a44200f235a",
  "_written_at": "2025-12-23T10:31:19.256097+00:00",
  "data": {
    "created_at": "2025-12-23T10:31:19.249444+00:00",
    "description": "## Sprint 17 Final Goal\nIntegrate SparkSLM with query expansion as optional primer.\n\n## Research Findings\n\n### Existing Code\n- `expand_query_with_spark()` already exists in `spark_api.py:234-292` - partial implementation\n- `SparkPredictor.prime()` returns: keywords, completions, alignment, topics\n\n### Implementation Plan (~220 lines)\n\n| File | Changes | LOC |\n|------|---------|-----|\n| `cortical/query/expansion.py` | Add `use_spark_primer` param + boost logic | 50 |\n| `cortical/query/__init__.py` | Export wrapper function | 10 |\n| `cortical/processor/query_api.py` | Add processor method | 20 |\n| Tests (unit + integration) | Coverage for new feature | 140 |\n\n### New Parameters for expand_query()\n```python\nuse_spark_primer: bool = False\nspark_predictor: Optional[SparkPredictor] = None\nspark_confidence_threshold: float = 0.10\nspark_boost_weight: float = 0.3\n```\n\n### Integration Logic\n1. Call `spark_predictor.prime(query)` after traditional expansion\n2. Add completions with prob >= threshold as candidates\n3. Boost existing terms matching alignment definitions\n4. Gracefully degrade if spark fails (try/except)\n\n### Edge Cases Handled\n- Untrained spark model → check `_trained` flag\n- Duplicate expansions → check `if token not in expanded`\n- Weight explosion → cap with `max_expansion_weight`\n- Performance → prime() is ~10ms, acceptable\n\n### Testing Strategy\n- Unit: spark disabled, none predictor, various thresholds\n- Integration: processor method, actual search quality\n- Existing patterns: follow `use_code_concepts` parameter pattern\n\n## Verification\n```bash\npython -m pytest tests/unit/test_query_expansion.py -v\npython -m pytest tests/unit/test_spark_integration.py -v\n```",
    "entity_type": "task",
    "id": "T-20251223-103119-49fa3858",
    "metadata": {},
    "modified_at": "2025-12-23T10:31:19.256061+00:00",
    "priority": "high",
    "properties": {
      "category": "feature"
    },
    "status": "pending",
    "title": "Implement SparkSLM query expansion integration",
    "version": 2
  }
}