name: CI - Test Suite

on:
  push:
  pull_request:
    branches: [ main ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ==========================================================================
  # Stage 1: Smoke Tests (< 30s)
  # Quick sanity check - if this fails, something is fundamentally broken
  # ==========================================================================
  smoke-tests:
    name: "ðŸ’¨ Smoke Tests"
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install test dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest

    - name: Run smoke tests
      run: |
        echo "=== Running Smoke Tests ==="
        python -m pytest tests/smoke/ -v --tb=short
        echo "âœ… Smoke tests passed"

  # ==========================================================================
  # Stage 2: Unit Tests with Coverage (< 2 min)
  # Fast, isolated tests for individual components
  # ==========================================================================
  unit-tests:
    name: "ðŸ§ª Unit Tests"
    runs-on: ubuntu-latest
    needs: smoke-tests
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install test dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest coverage

    - name: Run unit tests with coverage
      run: |
        echo "=== Running Unit Tests ==="
        # Run new pytest-based unit tests
        coverage run --source=cortical -m pytest tests/unit/ -v --tb=short

        # Also run existing unittest-based tests (they're still valuable)
        coverage run --append --source=cortical -m unittest discover -s tests -p "test_tokenizer.py" -v
        coverage run --append --source=cortical -m unittest discover -s tests -p "test_layers.py" -v
        coverage run --append --source=cortical -m unittest discover -s tests -p "test_config.py" -v
        coverage run --append --source=cortical -m unittest discover -s tests -p "test_code_concepts.py" -v
        coverage run --append --source=cortical -m unittest discover -s tests -p "test_embeddings.py" -v
        coverage run --append --source=cortical -m unittest discover -s tests -p "test_fingerprint.py" -v
        coverage run --append --source=cortical -m unittest discover -s tests -p "test_gaps.py" -v

        coverage report --include="cortical/*"
        coverage xml -o coverage-unit.xml

    - name: Upload unit test coverage
      uses: actions/upload-artifact@v4
      with:
        name: coverage-unit
        path: coverage-unit.xml

  # ==========================================================================
  # Stage 3: Integration Tests (< 3 min)
  # Tests for component interactions
  # ==========================================================================
  integration-tests:
    name: "ðŸ”— Integration Tests"
    runs-on: ubuntu-latest
    needs: unit-tests
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install test dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest coverage

    - name: Run integration tests with coverage
      run: |
        echo "=== Running Integration Tests ==="
        # Run existing integration-style tests
        coverage run --source=cortical -m unittest discover -s tests -p "test_processor.py" -v
        coverage run --append --source=cortical -m unittest discover -s tests -p "test_query.py" -v
        coverage run --append --source=cortical -m unittest discover -s tests -p "test_analysis.py" -v
        coverage run --append --source=cortical -m unittest discover -s tests -p "test_semantics.py" -v
        coverage run --append --source=cortical -m unittest discover -s tests -p "test_persistence.py" -v
        coverage run --append --source=cortical -m unittest discover -s tests -p "test_incremental_indexing.py" -v
        coverage run --append --source=cortical -m unittest discover -s tests -p "test_chunk_indexing.py" -v

        coverage report --include="cortical/*"
        coverage xml -o coverage-integration.xml

    - name: Upload integration test coverage
      uses: actions/upload-artifact@v4
      with:
        name: coverage-integration
        path: coverage-integration.xml

  # ==========================================================================
  # Stage 4: Regression Tests (< 1 min)
  # Tests for specific bugs that were fixed
  # ==========================================================================
  regression-tests:
    name: "ðŸ”’ Regression Tests"
    runs-on: ubuntu-latest
    needs: integration-tests
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install test dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest

    - name: Run regression tests
      run: |
        echo "=== Running Regression Tests ==="
        python -m pytest tests/regression/ -v --tb=short
        echo "âœ… All regressions still fixed"

  # ==========================================================================
  # Stage 5: Behavioral Tests (< 2 min)
  # Tests for user-facing quality and relevance
  # ==========================================================================
  behavioral-tests:
    name: "ðŸŽ¯ Behavioral Tests"
    runs-on: ubuntu-latest
    needs: integration-tests
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install test dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest

    - name: Run behavioral tests
      run: |
        echo "=== Running Behavioral Tests ==="
        python -m pytest tests/behavioral/ -v --tb=short
        echo "âœ… Behavioral quality verified"

  # ==========================================================================
  # Stage 6: Performance Tests (< 1 min, no coverage)
  # Timing-based tests to catch performance regressions
  # ==========================================================================
  performance-tests:
    name: "â±ï¸ Performance Tests"
    runs-on: ubuntu-latest
    needs: integration-tests
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install test dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest

    - name: Run performance tests
      run: |
        echo "=== Running Performance Tests (no coverage) ==="
        python -m pytest tests/performance/ -v --tb=short -s
        echo "âœ… Performance within thresholds"

  # ==========================================================================
  # Stage 7: Full Coverage Report
  # Combines coverage from unit + integration tests
  # ==========================================================================
  coverage-report:
    name: "ðŸ“Š Coverage Report"
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install coverage
      run: |
        python -m pip install --upgrade pip
        pip install coverage pytest

    - name: Download unit coverage
      uses: actions/download-artifact@v4
      with:
        name: coverage-unit
        path: .

    - name: Download integration coverage
      uses: actions/download-artifact@v4
      with:
        name: coverage-integration
        path: .

    - name: Generate combined coverage report
      run: |
        echo "=== Combined Coverage Report ==="
        # Run full test suite for comprehensive coverage
        coverage run --source=cortical -m unittest discover -s tests -v
        coverage report -m --include="cortical/*"
        coverage xml -o coverage.xml

        # Check threshold
        coverage report --fail-under=89 --include="cortical/*"

    - name: Upload final coverage report
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: coverage.xml

  # ==========================================================================
  # Showcase (main branch only, runs in parallel)
  # Runs the full showcase demo - independent of test results
  # ==========================================================================
  showcase:
    name: "ðŸŽ­ Showcase Demo"
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Run showcase
      run: |
        echo "=== Running Showcase Demo ==="
        python showcase.py
