{
  "hash": "eb24036ae71fa754e0113509d0e692f170211b06",
  "message": "Merge pull request #56 from scrawlsbenches/claude/fix-build-times-01WPZPJCvN7yKTAZLsbU14Fn",
  "author": "scrawlsbenches",
  "timestamp": "2025-12-13 07:20:02 -0500",
  "branch": "claude/multi-index-design-DvifZ",
  "files_changed": [
    ".github/workflows/ci.yml"
  ],
  "insertions": 97,
  "deletions": 52,
  "hunks": [
    {
      "file": "workflows/ci.yml b/.github/workflows/ci.yml",
      "function": "name: CI - Test Suite",
      "start_line": 8,
      "lines_added": [
        "# PARALLEL ARCHITECTURE (optimized for speed):",
        "#   smoke-tests (< 30s)",
        "#        â”‚",
        "#        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”",
        "#        â”‚                                              â”‚",
        "#        â–¼                                              â–¼",
        "#   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”",
        "#   â”‚ unit-tests â”€â”€â”€â”€â”€â”                   â”‚    â”‚ regression-tests â”‚",
        "#   â”‚ integration-tests â”‚ (with coverage) â”‚    â”‚ behavioral-tests â”‚",
        "#   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ performance-testsâ”‚",
        "#              â”‚                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜",
        "#              â–¼                                    (no coverage)",
        "#       coverage-report",
        "#     (combines coverage",
        "#      from unit + integration",
        "#      WITHOUT re-running tests)",
        "#",
        "# Each stage runs specific test files to avoid duplication.",
        "# coverage-report ONLY combines coverage data - it does NOT run tests again."
      ],
      "lines_removed": [
        "# Test stages run in dependency order:",
        "#   smoke â†’ unit â†’ integration â†’ [regression, behavioral, performance]",
        "#                              â†’ coverage-report",
        "# Each stage runs specific test directories/files to avoid duplication.",
        "# The final coverage-report stage runs ALL tests once for the combined number."
      ],
      "context_before": [
        "# DO NOT run both pytest and unittest on the same test files.",
        "# This doubles CI time and provides no benefit.",
        "#",
        "# âŒ WRONG (runs tests twice):",
        "#    coverage run -m pytest tests/",
        "#    coverage run --append -m unittest discover -s tests",
        "#",
        "# âœ… CORRECT (pytest handles both):",
        "#    coverage run -m pytest tests/",
        "#"
      ],
      "context_after": [
        "#",
        "# =============================================================================",
        "",
        "on:",
        "  push:",
        "  pull_request:",
        "    branches: [ main ]",
        "  workflow_dispatch:  # Allow manual triggering",
        "",
        "concurrency:",
        "  group: ${{ github.workflow }}-${{ github.ref }}"
      ],
      "change_type": "modify"
    },
    {
      "file": "workflows/ci.yml b/.github/workflows/ci.yml",
      "function": "jobs:",
      "start_line": 56,
      "lines_added": [
        "  # Runs in PARALLEL with integration-tests after smoke-tests pass"
      ],
      "lines_removed": [],
      "context_before": [
        "",
        "    - name: Run smoke tests",
        "      run: |",
        "        echo \"=== Running Smoke Tests ===\"",
        "        python -m pytest tests/smoke/ -v --tb=short",
        "        echo \"âœ… Smoke tests passed\"",
        "",
        "  # ==========================================================================",
        "  # Stage 2: Unit Tests with Coverage (< 2 min)",
        "  # Fast, isolated tests for individual components"
      ],
      "context_after": [
        "  # ==========================================================================",
        "  unit-tests:",
        "    name: \"ðŸ§ª Unit Tests\"",
        "    runs-on: ubuntu-latest",
        "    needs: smoke-tests",
        "    steps:",
        "    - uses: actions/checkout@v4",
        "",
        "    - name: Set up Python 3.11",
        "      uses: actions/setup-python@v5"
      ],
      "change_type": "add"
    },
    {
      "file": "workflows/ci.yml b/.github/workflows/ci.yml",
      "function": "jobs:",
      "start_line": 77,
      "lines_added": [
        "        # Run unit tests - pytest handles both pytest AND unittest style tests",
        "        # Using a single pytest call is faster than multiple unittest discovers",
        "        # Includes tests/unit/ plus related legacy tests",
        "        coverage run --source=cortical -m pytest \\",
        "          tests/unit/ \\",
        "          tests/test_tokenizer.py \\",
        "          tests/test_layers.py \\",
        "          tests/test_config.py \\",
        "          tests/test_code_concepts.py \\",
        "          tests/test_embeddings.py \\",
        "          tests/test_fingerprint.py \\",
        "          tests/test_gaps.py \\",
        "          tests/test_fluent.py \\",
        "          tests/test_progress.py \\",
        "          tests/test_results.py \\",
        "          -v --tb=short",
        "    - name: Upload unit test coverage data",
        "        path: .coverage",
        "        # Rename to avoid collision when combining",
        "        include-hidden-files: true",
        "  # Runs in PARALLEL with unit-tests after smoke-tests pass",
        "    needs: smoke-tests  # Changed: runs parallel with unit-tests",
        "        # Run integration tests - single pytest call is faster than multiple unittest discovers",
        "        # Includes tests/integration/ plus related legacy tests",
        "        coverage run --source=cortical -m pytest \\",
        "          tests/integration/ \\",
        "          tests/test_processor.py \\",
        "          tests/test_query.py \\",
        "          tests/test_analysis.py \\",
        "          tests/test_semantics.py \\",
        "          tests/test_persistence.py \\",
        "          tests/test_incremental_indexing.py \\",
        "          tests/test_chunk_indexing.py \\",
        "          tests/test_edge_cases.py \\",
        "          tests/test_coverage_gaps.py \\",
        "          tests/test_query_optimization.py \\",
        "          tests/test_intent_query.py \\",
        "          tests/test_analyze_louvain_resolution.py \\",
        "          tests/test_evaluate_cluster.py \\",
        "          tests/test_cli_wrapper.py \\",
        "          tests/test_search_codebase.py \\",
        "          tests/test_ask_codebase.py \\",
        "          tests/test_generate_ai_metadata.py \\",
        "          tests/test_showcase.py \\",
        "          -v --tb=short",
        "    - name: Upload integration test coverage data",
        "        path: .coverage",
        "        include-hidden-files: true",
        "  # Runs in PARALLEL with unit/integration after smoke-tests pass",
        "    needs: smoke-tests  # Changed: runs parallel, only needs smoke"
      ],
      "lines_removed": [
        "        # Run new pytest-based unit tests",
        "        coverage run --source=cortical -m pytest tests/unit/ -v --tb=short",
        "",
        "        # Also run existing unittest-based tests (they're still valuable)",
        "        coverage run --append --source=cortical -m unittest discover -s tests -p \"test_tokenizer.py\" -v",
        "        coverage run --append --source=cortical -m unittest discover -s tests -p \"test_layers.py\" -v",
        "        coverage run --append --source=cortical -m unittest discover -s tests -p \"test_config.py\" -v",
        "        coverage run --append --source=cortical -m unittest discover -s tests -p \"test_code_concepts.py\" -v",
        "        coverage run --append --source=cortical -m unittest discover -s tests -p \"test_embeddings.py\" -v",
        "        coverage run --append --source=cortical -m unittest discover -s tests -p \"test_fingerprint.py\" -v",
        "        coverage run --append --source=cortical -m unittest discover -s tests -p \"test_gaps.py\" -v",
        "        coverage xml -o coverage-unit.xml",
        "    - name: Upload unit test coverage",
        "        path: coverage-unit.xml",
        "    needs: unit-tests",
        "        # Run existing integration-style tests",
        "        coverage run --source=cortical -m unittest discover -s tests -p \"test_processor.py\" -v",
        "        coverage run --append --source=cortical -m unittest discover -s tests -p \"test_query.py\" -v",
        "        coverage run --append --source=cortical -m unittest discover -s tests -p \"test_analysis.py\" -v",
        "        coverage run --append --source=cortical -m unittest discover -s tests -p \"test_semantics.py\" -v",
        "        coverage run --append --source=cortical -m unittest discover -s tests -p \"test_persistence.py\" -v",
        "        coverage run --append --source=cortical -m unittest discover -s tests -p \"test_incremental_indexing.py\" -v",
        "        coverage run --append --source=cortical -m unittest discover -s tests -p \"test_chunk_indexing.py\" -v",
        "        coverage xml -o coverage-integration.xml",
        "    - name: Upload integration test coverage",
        "        path: coverage-integration.xml",
        "    needs: integration-tests"
      ],
      "context_before": [
        "        python-version: '3.11'",
        "",
        "    - name: Install test dependencies",
        "      run: |",
        "        python -m pip install --upgrade pip",
        "        pip install pytest coverage",
        "",
        "    - name: Run unit tests with coverage",
        "      run: |",
        "        echo \"=== Running Unit Tests ===\""
      ],
      "context_after": [
        "",
        "        coverage report --include=\"cortical/*\"",
        "",
        "      uses: actions/upload-artifact@v4",
        "      with:",
        "        name: coverage-unit",
        "",
        "  # ==========================================================================",
        "  # Stage 3: Integration Tests (< 3 min)",
        "  # Tests for component interactions",
        "  # ==========================================================================",
        "  integration-tests:",
        "    name: \"ðŸ”— Integration Tests\"",
        "    runs-on: ubuntu-latest",
        "    steps:",
        "    - uses: actions/checkout@v4",
        "",
        "    - name: Set up Python 3.11",
        "      uses: actions/setup-python@v5",
        "      with:",
        "        python-version: '3.11'",
        "",
        "    - name: Install test dependencies",
        "      run: |",
        "        python -m pip install --upgrade pip",
        "        pip install pytest coverage",
        "",
        "    - name: Run integration tests with coverage",
        "      run: |",
        "        echo \"=== Running Integration Tests ===\"",
        "",
        "        coverage report --include=\"cortical/*\"",
        "",
        "      uses: actions/upload-artifact@v4",
        "      with:",
        "        name: coverage-integration",
        "",
        "  # ==========================================================================",
        "  # Stage 4: Regression Tests (< 1 min)",
        "  # Tests for specific bugs that were fixed",
        "  # ==========================================================================",
        "  regression-tests:",
        "    name: \"ðŸ”’ Regression Tests\"",
        "    runs-on: ubuntu-latest",
        "    steps:",
        "    - uses: actions/checkout@v4",
        "",
        "    - name: Set up Python 3.11",
        "      uses: actions/setup-python@v5",
        "      with:",
        "        python-version: '3.11'",
        "",
        "    - name: Install test dependencies",
        "      run: |"
      ],
      "change_type": "modify"
    },
    {
      "file": "workflows/ci.yml b/.github/workflows/ci.yml",
      "function": "jobs:",
      "start_line": 170,
      "lines_added": [
        "  # Runs in PARALLEL with unit/integration after smoke-tests pass",
        "    needs: smoke-tests  # Changed: runs parallel, only needs smoke",
        "        # Includes tests/behavioral/ plus legacy test_behavioral.py",
        "        python -m pytest tests/behavioral/ tests/test_behavioral.py -v --tb=short",
        "  # Runs in PARALLEL with unit/integration after smoke-tests pass",
        "    needs: smoke-tests  # Changed: runs parallel, only needs smoke"
      ],
      "lines_removed": [
        "    needs: integration-tests",
        "        python -m pytest tests/behavioral/ -v --tb=short",
        "    needs: integration-tests"
      ],
      "context_before": [
        "",
        "    - name: Run regression tests",
        "      run: |",
        "        echo \"=== Running Regression Tests ===\"",
        "        python -m pytest tests/regression/ -v --tb=short",
        "        echo \"âœ… All regressions still fixed\"",
        "",
        "  # ==========================================================================",
        "  # Stage 5: Behavioral Tests (< 2 min)",
        "  # Tests for user-facing quality and relevance"
      ],
      "context_after": [
        "  # ==========================================================================",
        "  behavioral-tests:",
        "    name: \"ðŸŽ¯ Behavioral Tests\"",
        "    runs-on: ubuntu-latest",
        "    steps:",
        "    - uses: actions/checkout@v4",
        "",
        "    - name: Set up Python 3.11",
        "      uses: actions/setup-python@v5",
        "      with:",
        "        python-version: '3.11'",
        "",
        "    - name: Install test dependencies",
        "      run: |",
        "        python -m pip install --upgrade pip",
        "        pip install pytest",
        "",
        "    - name: Run behavioral tests",
        "      run: |",
        "        echo \"=== Running Behavioral Tests ===\"",
        "        echo \"âœ… Behavioral quality verified\"",
        "",
        "  # ==========================================================================",
        "  # Stage 6: Performance Tests (< 1 min, no coverage)",
        "  # Timing-based tests to catch performance regressions",
        "  # ==========================================================================",
        "  performance-tests:",
        "    name: \"â±ï¸ Performance Tests\"",
        "    runs-on: ubuntu-latest",
        "    steps:",
        "    - uses: actions/checkout@v4",
        "",
        "    - name: Set up Python 3.11",
        "      uses: actions/setup-python@v5",
        "      with:",
        "        python-version: '3.11'",
        "",
        "    - name: Install test dependencies",
        "      run: |"
      ],
      "change_type": "modify"
    },
    {
      "file": "workflows/ci.yml b/.github/workflows/ci.yml",
      "function": "jobs:",
      "start_line": 223,
      "lines_added": [
        "  # Combines coverage from unit + integration tests WITHOUT re-running tests",
        "        pip install coverage",
        "        path: coverage-unit",
        "        path: coverage-integration",
        "    - name: Combine coverage data and generate report",
        "        echo \"=== Combining Coverage Data ===\"",
        "        # âš ï¸  IMPORTANT: This job ONLY combines coverage - NO test runs!",
        "        # Tests were already run in unit-tests and integration-tests stages.",
        "        # Running tests again here would double CI time.",
        "        # We use 'coverage combine' to merge the .coverage files from",
        "        # the parallel test jobs.",
        "",
        "        # Move coverage files to current directory with unique names",
        "        mv coverage-unit/.coverage .coverage.unit",
        "        mv coverage-integration/.coverage .coverage.integration",
        "        # Combine coverage data from both jobs",
        "        coverage combine .coverage.unit .coverage.integration",
        "        # Generate reports",
        "        echo \"=== Coverage Report ===\"",
        "        # Check threshold (fail if below 89%)",
        "        echo \"âœ… Coverage threshold met\""
      ],
      "lines_removed": [
        "  # Combines coverage from unit + integration tests",
        "        pip install coverage pytest",
        "        path: .",
        "        path: .",
        "    - name: Generate combined coverage report",
        "        echo \"=== Combined Coverage Report ===\"",
        "        # âš ï¸  IMPORTANT: DO NOT add duplicate test runs here!",
        "        #",
        "        # Pytest runs unittest-based tests natively - no need to run both.",
        "        # Running tests twice doubles CI time (from ~7min to ~15min+).",
        "        # If you need to add tests, add them to the appropriate stage above",
        "        # (unit-tests, integration-tests, etc.) NOT here.",
        "        # This job combines coverage from artifacts, then runs a single",
        "        # comprehensive pass for the final coverage number.",
        "        # Single test run - pytest handles both pytest AND unittest style tests",
        "        coverage run --source=cortical -m pytest tests/ -v --ignore=tests/performance/",
        "        # Check threshold"
      ],
      "context_before": [
        "        pip install pytest",
        "",
        "    - name: Run performance tests",
        "      run: |",
        "        echo \"=== Running Performance Tests (no coverage) ===\"",
        "        python -m pytest tests/performance/ -v --tb=short -s",
        "        echo \"âœ… Performance within thresholds\"",
        "",
        "  # ==========================================================================",
        "  # Stage 7: Full Coverage Report"
      ],
      "context_after": [
        "  # ==========================================================================",
        "  coverage-report:",
        "    name: \"ðŸ“Š Coverage Report\"",
        "    runs-on: ubuntu-latest",
        "    needs: [unit-tests, integration-tests]",
        "    steps:",
        "    - uses: actions/checkout@v4",
        "",
        "    - name: Set up Python 3.11",
        "      uses: actions/setup-python@v5",
        "      with:",
        "        python-version: '3.11'",
        "",
        "    - name: Install coverage",
        "      run: |",
        "        python -m pip install --upgrade pip",
        "",
        "    - name: Download unit coverage",
        "      uses: actions/download-artifact@v4",
        "      with:",
        "        name: coverage-unit",
        "",
        "    - name: Download integration coverage",
        "      uses: actions/download-artifact@v4",
        "      with:",
        "        name: coverage-integration",
        "",
        "      run: |",
        "        #",
        "        #",
        "",
        "",
        "        coverage report -m --include=\"cortical/*\"",
        "        coverage xml -o coverage.xml",
        "",
        "        coverage report --fail-under=89 --include=\"cortical/*\"",
        "",
        "    - name: Upload final coverage report",
        "      uses: actions/upload-artifact@v4",
        "      with:",
        "        name: coverage-report",
        "        path: coverage.xml",
        "",
        "  # ==========================================================================",
        "  # Showcase (main branch or manual trigger, runs in parallel)",
        "  # Runs the full showcase demo - independent of test results"
      ],
      "change_type": "modify"
    }
  ],
  "hour_of_day": 12,
  "day_of_week": "Saturday",
  "seconds_since_last_commit": -177886,
  "is_merge": true,
  "is_initial": false,
  "parent_count": 2,
  "session_id": null,
  "related_chats": [],
  "ci_result": null,
  "reverted": false,
  "amended": false
}