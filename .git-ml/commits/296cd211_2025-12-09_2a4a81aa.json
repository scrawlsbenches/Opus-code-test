{
  "hash": "296cd21186207d5e9489b770816c85a492fe86c3",
  "message": "Fix type annotation and optimize spectral embeddings lookup",
  "author": "Claude",
  "timestamp": "2025-12-09 19:46:36 +0000",
  "branch": "claude/multi-index-design-DvifZ",
  "files_changed": [
    "cortical/embeddings.py"
  ],
  "insertions": 7,
  "deletions": 8,
  "hunks": [
    {
      "file": "cortical/embeddings.py",
      "function": "Graph-based embeddings for the cortical network.",
      "start_line": 6,
      "lines_added": [
        "from typing import Any, Dict, List, Tuple, Optional",
        ") -> Tuple[Dict[str, List[float]], Dict[str, Any]]:"
      ],
      "lines_removed": [
        "from typing import Dict, List, Tuple, Optional",
        ") -> Tuple[Dict[str, List[float]], Dict[str, any]]:"
      ],
      "context_before": [
        "",
        "Implements three methods for computing term embeddings from the",
        "connection graph structure:",
        "1. Adjacency: Direct connection weights to landmark nodes",
        "2. Random Walk: DeepWalk-inspired walk co-occurrence",
        "3. Spectral: Graph Laplacian eigenvector approximation",
        "\"\"\"",
        "",
        "import math",
        "import random"
      ],
      "context_after": [
        "from collections import defaultdict",
        "",
        "from .layers import CorticalLayer, HierarchicalLayer",
        "",
        "",
        "def compute_graph_embeddings(",
        "    layers: Dict[CorticalLayer, HierarchicalLayer],",
        "    dimensions: int = 64,",
        "    method: str = 'adjacency'",
        "    \"\"\"",
        "    Compute embeddings for tokens based on graph structure.",
        "    ",
        "    Args:",
        "        layers: Dictionary of layers (needs TOKENS)",
        "        dimensions: Number of embedding dimensions",
        "        method: 'adjacency', 'random_walk', or 'spectral'",
        "        ",
        "    Returns:",
        "        Tuple of (embeddings dict, statistics dict)"
      ],
      "change_type": "modify"
    },
    {
      "file": "cortical/embeddings.py",
      "function": "def _spectral_embeddings(layer: HierarchicalLayer, dimensions: int, iterations:",
      "start_line": 141,
      "lines_added": [
        "            neighbor = layer.get_by_id(neighbor_id)",
        "            if neighbor and neighbor.content in term_to_idx:",
        "                j = term_to_idx[neighbor.content]",
        "                adjacency[i][j] = weight",
        "                degrees[i] += weight"
      ],
      "lines_removed": [
        "            for t, c in layer.minicolumns.items():",
        "                if c.id == neighbor_id:",
        "                    j = term_to_idx[t]",
        "                    adjacency[i][j] = weight",
        "                    degrees[i] += weight",
        "                    break"
      ],
      "context_before": [
        "    if n == 0:",
        "        return embeddings",
        "    ",
        "    term_to_idx = {t: i for i, t in enumerate(terms)}",
        "    adjacency: Dict[int, Dict[int, float]] = defaultdict(dict)",
        "    degrees = [0.0] * n",
        "    ",
        "    for term, col in layer.minicolumns.items():",
        "        i = term_to_idx[term]",
        "        for neighbor_id, weight in col.lateral_connections.items():"
      ],
      "context_after": [
        "    ",
        "    degrees = [d if d > 0 else 1.0 for d in degrees]",
        "    actual_dims = min(dimensions, n)",
        "    vectors = []",
        "    ",
        "    for d in range(actual_dims):",
        "        vec = [random.gauss(0, 1) for _ in range(n)]",
        "        for prev in vectors:",
        "            dot = sum(v * p for v, p in zip(vec, prev))",
        "            vec = [v - dot * p for v, p in zip(vec, prev)]"
      ],
      "change_type": "modify"
    }
  ],
  "hour_of_day": 19,
  "day_of_week": "Tuesday",
  "seconds_since_last_commit": -496692,
  "is_merge": false,
  "is_initial": false,
  "parent_count": 1,
  "session_id": null,
  "related_chats": [],
  "ci_result": null,
  "reverted": false,
  "amended": false
}