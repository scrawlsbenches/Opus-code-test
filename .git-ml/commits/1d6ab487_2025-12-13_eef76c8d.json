{
  "hash": "1d6ab487b0bf93c9a670ed5075ebe0e04586b764",
  "message": "Add CI pending tasks reporter with GitHub Actions integration",
  "author": "Claude",
  "timestamp": "2025-12-13 23:34:31 +0000",
  "branch": "claude/multi-index-design-DvifZ",
  "files_changed": [
    ".github/workflows/ci.yml",
    "scripts/ci_task_report.py",
    "tasks/2025-12-13_22-33-34_2d89.json"
  ],
  "insertions": 267,
  "deletions": 4,
  "hunks": [
    {
      "file": "workflows/ci.yml b/.github/workflows/ci.yml",
      "function": "jobs:",
      "start_line": 63,
      "lines_added": [
        "    - name: Report Pending Tasks",
        "      if: always()",
        "      run: |",
        "        echo \"=== Pending Tasks Report ===\"",
        "        python scripts/ci_task_report.py --github",
        "      env:",
        "        GITHUB_STEP_SUMMARY: ${{ github.step_summary }}",
        ""
      ],
      "lines_removed": [],
      "context_before": [
        "      uses: actions/setup-python@v5",
        "      with:",
        "        python-version: '3.11'",
        "",
        "    - name: Validate TASK_LIST.md",
        "      run: |",
        "        echo \"=== Validating Task List ===\"",
        "        python scripts/validate_task_list.py",
        "        echo \"‚úÖ Task list validation passed\"",
        ""
      ],
      "context_after": [
        "  # ==========================================================================",
        "  # Stage 1: Smoke Tests (< 30s)",
        "  # Quick sanity check - if this fails, something is fundamentally broken",
        "  # ==========================================================================",
        "  smoke-tests:",
        "    name: \"üí® Smoke Tests\"",
        "    runs-on: ubuntu-latest",
        "    steps:",
        "    - uses: actions/checkout@v4",
        ""
      ],
      "change_type": "add"
    },
    {
      "file": "scripts/ci_task_report.py",
      "function": null,
      "start_line": 0,
      "lines_added": [
        "#!/usr/bin/env python3",
        "\"\"\"",
        "CI Task Reporter - Intelligent pending task output for CI pipelines.",
        "",
        "This script outputs pending tasks in a CI-friendly format, suitable for:",
        "- GitHub Actions job summaries",
        "- Console output during CI runs",
        "- Slack/Discord notifications",
        "",
        "Features:",
        "- Groups by priority (high items first)",
        "- Shows estimated effort",
        "- Provides actionable summary",
        "- Exits with non-zero code if high-priority tasks exist (optional)",
        "",
        "Usage:",
        "    # Standard output",
        "    python scripts/ci_task_report.py",
        "",
        "    # GitHub Actions markdown format (writes to $GITHUB_STEP_SUMMARY)",
        "    python scripts/ci_task_report.py --github",
        "",
        "    # Fail CI if high-priority tasks pending",
        "    python scripts/ci_task_report.py --fail-on-high",
        "",
        "    # Quiet mode (summary only)",
        "    python scripts/ci_task_report.py --quiet",
        "\"\"\"",
        "",
        "import argparse",
        "import os",
        "import sys",
        "from pathlib import Path",
        "from typing import Dict, List",
        "",
        "# Add scripts to path",
        "sys.path.insert(0, str(Path(__file__).parent))",
        "",
        "from task_utils import load_all_tasks, Task, DEFAULT_TASKS_DIR",
        "",
        "",
        "def get_pending_tasks(tasks_dir: str = DEFAULT_TASKS_DIR) -> List[Task]:",
        "    \"\"\"Load only pending and in_progress tasks.\"\"\"",
        "    all_tasks = load_all_tasks(tasks_dir)",
        "    return [t for t in all_tasks if t.status in (\"pending\", \"in_progress\")]",
        "",
        "",
        "def group_by_priority(tasks: List[Task]) -> Dict[str, List[Task]]:",
        "    \"\"\"Group tasks by priority.\"\"\"",
        "    grouped = {\"high\": [], \"medium\": [], \"low\": []}",
        "    for task in tasks:",
        "        priority = task.priority if task.priority in grouped else \"medium\"",
        "        grouped[priority].append(task)",
        "    return grouped",
        "",
        "",
        "def format_console_report(tasks: List[Task]) -> str:",
        "    \"\"\"Format tasks for console output.\"\"\"",
        "    if not tasks:",
        "        return \"‚úÖ No pending tasks!\\n\"",
        "",
        "    grouped = group_by_priority(tasks)",
        "    lines = []",
        "",
        "    # Summary header",
        "    total = len(tasks)",
        "    high_count = len(grouped[\"high\"])",
        "    in_progress = sum(1 for t in tasks if t.status == \"in_progress\")",
        "",
        "    lines.append(\"=\" * 60)",
        "    lines.append(f\"üìã PENDING TASKS: {total} total ({high_count} high priority)\")",
        "    if in_progress:",
        "        lines.append(f\"   üîÑ {in_progress} currently in progress\")",
        "    lines.append(\"=\" * 60)",
        "",
        "    # Priority sections",
        "    priority_config = [",
        "        (\"high\", \"üî¥ HIGH PRIORITY\", \"These need attention!\"),",
        "        (\"medium\", \"üü° MEDIUM PRIORITY\", \"\"),",
        "        (\"low\", \"üü¢ LOW PRIORITY\", \"\"),",
        "    ]",
        "",
        "    for priority, header, note in priority_config:",
        "        if not grouped[priority]:",
        "            continue",
        "        lines.append(\"\")",
        "        lines.append(f\"{header}\" + (f\" - {note}\" if note else \"\"))",
        "        lines.append(\"-\" * 40)",
        "",
        "        for task in grouped[priority]:",
        "            status_marker = \"üîÑ\" if task.status == \"in_progress\" else \"  \"",
        "            effort_marker = {\"small\": \"S\", \"medium\": \"M\", \"large\": \"L\"}.get(task.effort, \"?\")",
        "            lines.append(f\"  {status_marker} [{effort_marker}] {task.id}\")",
        "            lines.append(f\"       {task.title}\")",
        "",
        "    lines.append(\"\")",
        "    lines.append(\"=\" * 60)",
        "",
        "    # Actionable summary",
        "    if high_count > 0:",
        "        lines.append(\"‚ö†Ô∏è  HIGH PRIORITY TASKS REQUIRE ATTENTION\")",
        "",
        "    return \"\\n\".join(lines)",
        "",
        "",
        "def format_github_markdown(tasks: List[Task]) -> str:",
        "    \"\"\"Format tasks as GitHub-flavored markdown for job summary.\"\"\"",
        "    if not tasks:",
        "        return \"## ‚úÖ No Pending Tasks\\n\\nAll tasks have been completed!\\n\"",
        "",
        "    grouped = group_by_priority(tasks)",
        "    lines = []",
        "",
        "    # Summary header",
        "    total = len(tasks)",
        "    high_count = len(grouped[\"high\"])",
        "    in_progress = sum(1 for t in tasks if t.status == \"in_progress\")",
        "",
        "    lines.append(\"## üìã Pending Tasks Summary\")",
        "    lines.append(\"\")",
        "    lines.append(f\"| Metric | Count |\")",
        "    lines.append(\"|--------|-------|\")",
        "    lines.append(f\"| Total Pending | **{total}** |\")",
        "    lines.append(f\"| üî¥ High Priority | {high_count} |\")",
        "    lines.append(f\"| üü° Medium Priority | {len(grouped['medium'])} |\")",
        "    lines.append(f\"| üü¢ Low Priority | {len(grouped['low'])} |\")",
        "    lines.append(f\"| üîÑ In Progress | {in_progress} |\")",
        "    lines.append(\"\")",
        "",
        "    # High priority callout",
        "    if high_count > 0:",
        "        lines.append(\"> ‚ö†Ô∏è **Attention:** There are high-priority tasks that need attention!\")",
        "        lines.append(\"\")",
        "",
        "    # Task tables by priority",
        "    priority_config = [",
        "        (\"high\", \"### üî¥ High Priority\"),",
        "        (\"medium\", \"### üü° Medium Priority\"),",
        "        (\"low\", \"### üü¢ Low Priority\"),",
        "    ]",
        "",
        "    for priority, header in priority_config:",
        "        if not grouped[priority]:",
        "            continue",
        "",
        "        lines.append(header)",
        "        lines.append(\"\")",
        "        lines.append(\"| Status | ID | Title | Effort | Category |\")",
        "        lines.append(\"|--------|----|----|--------|----------|\")",
        "",
        "        for task in grouped[priority]:",
        "            status = \"üîÑ\" if task.status == \"in_progress\" else \"üìã\"",
        "            effort = {\"small\": \"S\", \"medium\": \"M\", \"large\": \"L\"}.get(task.effort, \"?\")",
        "            # Escape pipe characters in title",
        "            title = task.title.replace(\"|\", \"\\\\|\")",
        "            lines.append(f\"| {status} | `{task.id}` | {title} | {effort} | {task.category} |\")",
        "",
        "        lines.append(\"\")",
        "",
        "    # Quick commands",
        "    lines.append(\"<details>\")",
        "    lines.append(\"<summary>üìå Quick Commands</summary>\")",
        "    lines.append(\"\")",
        "    lines.append(\"```bash\")",
        "    lines.append(\"# List all tasks\")",
        "    lines.append(\"python scripts/new_task.py --list\")",
        "    lines.append(\"\")",
        "    lines.append(\"# Complete a task\")",
        "    lines.append(\"python scripts/new_task.py --complete T-XXXXX\")",
        "    lines.append(\"\")",
        "    lines.append(\"# Create new task\")",
        "    lines.append('python scripts/new_task.py \"Task title\" --priority high')",
        "    lines.append(\"```\")",
        "    lines.append(\"</details>\")",
        "",
        "    return \"\\n\".join(lines)",
        "",
        "",
        "def format_quiet_report(tasks: List[Task]) -> str:",
        "    \"\"\"Minimal one-line summary.\"\"\"",
        "    if not tasks:",
        "        return \"Tasks: 0 pending\"",
        "",
        "    grouped = group_by_priority(tasks)",
        "    return (",
        "        f\"Tasks: {len(tasks)} pending \"",
        "        f\"(üî¥{len(grouped['high'])} üü°{len(grouped['medium'])} üü¢{len(grouped['low'])})\"",
        "    )",
        "",
        "",
        "def main():",
        "    parser = argparse.ArgumentParser(",
        "        description=\"CI Task Reporter - Output pending tasks for CI pipelines\",",
        "        formatter_class=argparse.RawDescriptionHelpFormatter,",
        "        epilog=__doc__",
        "    )",
        "",
        "    parser.add_argument(",
        "        \"--github\", action=\"store_true\",",
        "        help=\"Output GitHub-flavored markdown (writes to GITHUB_STEP_SUMMARY if available)\"",
        "    )",
        "    parser.add_argument(",
        "        \"--fail-on-high\", action=\"store_true\",",
        "        help=\"Exit with code 1 if high-priority tasks exist\"",
        "    )",
        "    parser.add_argument(",
        "        \"--quiet\", \"-q\", action=\"store_true\",",
        "        help=\"Minimal output (summary line only)\"",
        "    )",
        "    parser.add_argument(",
        "        \"--dir\", default=DEFAULT_TASKS_DIR,",
        "        help=f\"Tasks directory (default: {DEFAULT_TASKS_DIR})\"",
        "    )",
        "    parser.add_argument(",
        "        \"--output\", \"-o\",",
        "        help=\"Write report to file instead of stdout\"",
        "    )",
        "",
        "    args = parser.parse_args()",
        "",
        "    # Load pending tasks",
        "    tasks = get_pending_tasks(args.dir)",
        "",
        "    # Format report",
        "    if args.quiet:",
        "        report = format_quiet_report(tasks)",
        "    elif args.github:",
        "        report = format_github_markdown(tasks)",
        "    else:",
        "        report = format_console_report(tasks)",
        "",
        "    # Output report",
        "    if args.output:",
        "        with open(args.output, \"w\") as f:",
        "            f.write(report)",
        "        print(f\"Report written to: {args.output}\")",
        "    else:",
        "        print(report)",
        "",
        "    # GitHub Actions: Write to step summary if available",
        "    if args.github and \"GITHUB_STEP_SUMMARY\" in os.environ:",
        "        summary_file = os.environ[\"GITHUB_STEP_SUMMARY\"]",
        "        with open(summary_file, \"a\") as f:",
        "            f.write(report + \"\\n\")",
        "",
        "    # Exit code logic",
        "    if args.fail_on_high:",
        "        grouped = group_by_priority(tasks)",
        "        if grouped[\"high\"]:",
        "            print(f\"\\n‚ùå Failing: {len(grouped['high'])} high-priority tasks pending\")",
        "            sys.exit(1)",
        "",
        "",
        "if __name__ == \"__main__\":",
        "    main()"
      ],
      "lines_removed": [],
      "context_before": [],
      "context_after": [],
      "change_type": "add"
    },
    {
      "file": "tasks/2025-12-13_22-33-34_2d89.json",
      "function": null,
      "start_line": 1,
      "lines_added": [
        "  \"saved_at\": \"2025-12-13T23:34:11.766195\",",
        "      \"status\": \"completed\",",
        "      \"updated_at\": \"2025-12-13T23:34:11.766071\",",
        "      \"completed_at\": \"2025-12-13T23:34:11.766071\","
      ],
      "lines_removed": [
        "  \"saved_at\": \"2025-12-13T23:25:22.253602\",",
        "      \"status\": \"pending\",",
        "      \"updated_at\": null,",
        "      \"completed_at\": null,"
      ],
      "context_before": [
        "{",
        "  \"version\": 1,",
        "  \"session_id\": \"2d89\",",
        "  \"started_at\": \"2025-12-13T22:33:34.431014\","
      ],
      "context_after": [
        "  \"tasks\": [",
        "    {",
        "      \"id\": \"T-20251213-223334-2d89-01\",",
        "      \"title\": \"Investigate performance bottleneck in search\",",
        "      \"status\": \"pending\",",
        "      \"priority\": \"high\",",
        "      \"category\": \"perf\",",
        "      \"description\": \"\",",
        "      \"depends_on\": [],",
        "      \"effort\": \"medium\",",
        "      \"created_at\": \"2025-12-13T22:33:34.431621\",",
        "      \"updated_at\": null,",
        "      \"completed_at\": null,",
        "      \"context\": {}",
        "    },",
        "    {",
        "      \"id\": \"T-20251213-232522-2d89-002\",",
        "      \"title\": \"Update CI to output pending tasks intelligently\",",
        "      \"priority\": \"medium\",",
        "      \"category\": \"automation\",",
        "      \"description\": \"Add a CI step that shows pending tasks in a smart way: grouped by priority, showing blockers first, with context about what's ready to work on next. Could integrate with the workflow system to show task chains and dependencies.\",",
        "      \"depends_on\": [],",
        "      \"effort\": \"medium\",",
        "      \"created_at\": \"2025-12-13T23:25:22.253447\",",
        "      \"context\": {}",
        "    }",
        "  ]",
        "}"
      ],
      "change_type": "modify"
    }
  ],
  "hour_of_day": 23,
  "day_of_week": "Saturday",
  "seconds_since_last_commit": -137417,
  "is_merge": false,
  "is_initial": false,
  "parent_count": 1,
  "session_id": null,
  "related_chats": [],
  "ci_result": null,
  "reverted": false,
  "amended": false
}