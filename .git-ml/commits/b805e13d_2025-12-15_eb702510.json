{
  "hash": "b805e13dd54bbba20151a4050435f18c22db4527",
  "message": "feat: Add automatic ML data collection on session startup",
  "author": "Claude",
  "timestamp": "2025-12-15 14:09:10 +0000",
  "branch": "claude/multi-index-design-DvifZ",
  "files_changed": [
    ".claude/settings.local.json",
    "CLAUDE.md",
    "scripts/ml-session-start-hook.sh"
  ],
  "insertions": 95,
  "deletions": 22,
  "hunks": [
    {
      "file": ".claude/settings.local.json",
      "function": null,
      "start_line": 1,
      "lines_added": [
        "    \"SessionStart\": [",
        "      {",
        "        \"type\": \"command\",",
        "        \"command\": \"./scripts/ml-session-start-hook.sh\"",
        "      }",
        "    ],"
      ],
      "lines_removed": [],
      "context_before": [
        "{",
        "  \"hooks\": {"
      ],
      "context_after": [
        "    \"Stop\": [",
        "      {",
        "        \"type\": \"command\",",
        "        \"command\": \"./scripts/ml-session-capture-hook.sh\"",
        "      }",
        "    ]",
        "  }",
        "}"
      ],
      "change_type": "add"
    },
    {
      "file": "CLAUDE.md",
      "function": "When completing a task, consider creating a memory entry from the retrospective:",
      "start_line": 1324,
      "lines_added": [
        "**Fully automatic. Zero configuration required.**",
        "",
        "ML data collection starts automatically when you open this project in Claude Code. Every session is tracked, every commit is captured, and transcripts are saved when sessions end.",
        "",
        "### Automatic Startup",
        "",
        "When a Claude Code session starts in this project:",
        "1. **Session tracking begins** - A new ML session is created for commit-chat linking",
        "2. **Git hooks are installed** - post-commit and pre-push hooks are added if missing",
        "3. **Stats are displayed** - Current collection progress is shown",
        "",
        "This is configured in `.claude/settings.local.json` via the `SessionStart` hook."
      ],
      "lines_removed": [
        "The project automatically collects enriched commit and chat data to train a micro-model that learns THIS project's patterns, coding style, and workflows."
      ],
      "context_before": [
        "- What was learned?",
        "- What connections were made?",
        "- What should future developers know?",
        "",
        "See `docs/text-as-memories.md` for the full guide.",
        "",
        "---",
        "",
        "## ML Data Collection: Project-Specific Micro-Model",
        ""
      ],
      "context_after": [
        "",
        "### What Gets Collected",
        "",
        "| Data Type | Location | Contents |",
        "|-----------|----------|----------|",
        "| **Commits** | `.git-ml/commits/` | Git history with diff hunks, temporal context, CI results |",
        "| **Chats** | `.git-ml/chats/` | Query/response pairs with files touched and tools used |",
        "| **Sessions** | `.git-ml/sessions/` | Development sessions linking chats to commits |",
        "| **Actions** | `.git-ml/actions/` | Individual tool uses and operations |",
        ""
      ],
      "change_type": "modify"
    },
    {
      "file": "CLAUDE.md",
      "function": "python scripts/ml_data_collector.py backfill -n 100",
      "start_line": 1375,
      "lines_added": [
        "**Pre-configured. No setup needed.**",
        "The ML data collector automatically captures complete session transcripts when Claude Code sessions end. This is already configured in `.claude/settings.local.json`.",
        "Data collection is fully automatic via hooks configured in `.claude/settings.local.json`:",
        "",
        "| Hook | Trigger | Action |",
        "|------|---------|--------|",
        "| **SessionStart** | Session begins | Starts ML session, installs git hooks, shows stats |",
        "| **Stop** | Session ends | Captures full transcript with all exchanges |",
        "| **post-commit** | After commit | Captures commit metadata with diff hunks |",
        "| **pre-push** | Before push | Reports collection stats |",
        "",
        "**Hook files:**",
        "- `scripts/ml-session-start-hook.sh` - SessionStart handler",
        "- `scripts/ml-session-capture-hook.sh` - Stop handler"
      ],
      "lines_removed": [
        "**Zero-friction capture via Claude Code Stop hook:**",
        "The ML data collector automatically captures complete session transcripts when Claude Code sessions end. This eliminates manual logging entirely.",
        "",
        "**Setup:**",
        "```bash",
        "# Add to ~/.claude/settings.json or project .claude/settings.json:",
        "{",
        "  \"hooks\": {",
        "    \"Stop\": [",
        "      {",
        "        \"type\": \"command\",",
        "        \"command\": \"/path/to/Opus-code-test/scripts/ml-session-capture-hook.sh\"",
        "      }",
        "    ]",
        "  }",
        "}",
        "```",
        "Data collection is automatic via hooks:",
        "- **Stop hook**: Captures full session transcripts with all exchanges (recommended)",
        "- **post-commit**: Captures commit metadata with diff hunks",
        "- **pre-push**: Reports collection stats"
      ],
      "context_before": [
        "",
        "```bash",
        "# Disable for current session",
        "export ML_COLLECTION_ENABLED=0",
        "",
        "# Stats and validation still work when disabled",
        "```",
        "",
        "### Automatic Session Capture",
        ""
      ],
      "context_after": [
        "",
        "",
        "**What gets captured automatically:**",
        "- Full query/response pairs from the transcript",
        "- All tool uses (Task, Read, Edit, Bash, Grep, etc.)",
        "- Files referenced and modified",
        "- Thinking blocks (if present)",
        "- Session linkage to commits",
        "",
        "**Process transcript manually:**",
        "```bash",
        "# Process a specific transcript file",
        "python scripts/ml_data_collector.py transcript --file /path/to/transcript.jsonl",
        "",
        "# Dry run (show what would be captured without saving)",
        "python scripts/ml_data_collector.py transcript --file /path/to/transcript.jsonl --dry-run --verbose",
        "```",
        "",
        "### Integration",
        "",
        "",
        "See `.claude/skills/ml-logger/SKILL.md` for detailed logging usage.",
        "",
        "---",
        "",
        "## File Quick Links",
        "",
        "- **Main API**: `cortical/processor/` - `CorticalTextProcessor` class (split into mixins)",
        "- **Graph algorithms**: `cortical/analysis.py` - PageRank, TF-IDF, clustering",
        "- **Search**: `cortical/query/` - query expansion, document retrieval (split into 8 modules)"
      ],
      "change_type": "modify"
    },
    {
      "file": "scripts/ml-session-start-hook.sh",
      "function": null,
      "start_line": 0,
      "lines_added": [
        "#!/bin/bash",
        "#",
        "# ML Session Start Hook for Claude Code",
        "#",
        "# This SessionStart hook automatically initializes ML data collection.",
        "# It runs at the start of every Claude Code session in this project.",
        "#",
        "# What it does:",
        "# 1. Starts a new ML session for commit-chat linking",
        "# 2. Installs git hooks if not present",
        "# 3. Shows collection stats",
        "#",
        "",
        "# Read JSON input from stdin (Claude Code provides session context)",
        "input=$(cat)",
        "",
        "# Extract working directory",
        "cwd=$(echo \"$input\" | jq -r '.cwd // empty' 2>/dev/null)",
        "if [[ -z \"$cwd\" ]]; then",
        "    cwd=\"$(pwd)\"",
        "fi",
        "",
        "# Only run for this specific project",
        "if [[ ! -f \"${cwd}/scripts/ml_data_collector.py\" ]]; then",
        "    exit 0",
        "fi",
        "",
        "cd \"$cwd\" || exit 0",
        "",
        "# Check if ML collection is disabled",
        "if [[ \"${ML_COLLECTION_ENABLED:-1}\" == \"0\" ]]; then",
        "    echo \"ğŸ“Š ML collection disabled (ML_COLLECTION_ENABLED=0)\"",
        "    exit 0",
        "fi",
        "",
        "# Ensure .git-ml directory exists",
        "mkdir -p .git-ml",
        "",
        "# Install git hooks if not present",
        "if [[ ! -f \".git/hooks/post-commit\" ]] || ! grep -q \"ML-DATA-COLLECTOR\" \".git/hooks/post-commit\" 2>/dev/null; then",
        "    python3 scripts/ml_data_collector.py install-hooks 2>/dev/null",
        "fi",
        "",
        "# Start a new session",
        "session_output=$(python3 scripts/ml_data_collector.py session start 2>/dev/null)",
        "session_id=$(echo \"$session_output\" | grep -oP 'Started session: \\K.*' || echo \"\")",
        "",
        "# Get current stats",
        "stats=$(python3 scripts/ml_data_collector.py stats 2>/dev/null | grep -E \"Commits:|Chats:|Sessions:\" | head -3)",
        "",
        "# Output session info",
        "echo \"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\"",
        "echo \"ğŸ“Š ML Data Collection Active\"",
        "echo \"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\"",
        "if [[ -n \"$session_id\" ]]; then",
        "    echo \"   Session: $session_id\"",
        "fi",
        "echo \"$stats\" | while read line; do",
        "    echo \"   $line\"",
        "done",
        "echo \"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\"",
        "",
        "exit 0"
      ],
      "lines_removed": [],
      "context_before": [],
      "context_after": [],
      "change_type": "add"
    }
  ],
  "hour_of_day": 14,
  "day_of_week": "Monday",
  "seconds_since_last_commit": 287,
  "is_merge": false,
  "is_initial": false,
  "parent_count": 1,
  "session_id": null,
  "related_chats": [],
  "ci_result": null,
  "reverted": false,
  "amended": false
}