{
  "hash": "add2a02d83e39f2156e482c4c2402b4589c2adc1",
  "message": "Fix CI running tests twice, add documentation to prevent future issues",
  "author": "Claude",
  "timestamp": "2025-12-13 10:57:43 +0000",
  "branch": "claude/multi-index-design-DvifZ",
  "files_changed": [
    ".github/workflows/ci.yml",
    "CLAUDE.md"
  ],
  "insertions": 61,
  "deletions": 4,
  "hunks": [
    {
      "file": "workflows/ci.yml b/.github/workflows/ci.yml",
      "function": null,
      "start_line": 1,
      "lines_added": [
        "# =============================================================================",
        "# CI TEST ARCHITECTURE - READ BEFORE MODIFYING",
        "# =============================================================================",
        "#",
        "# CRITICAL: Pytest runs unittest-based tests natively!",
        "# DO NOT run both pytest and unittest on the same test files.",
        "# This doubles CI time and provides no benefit.",
        "#",
        "# ❌ WRONG (runs tests twice):",
        "#    coverage run -m pytest tests/",
        "#    coverage run --append -m unittest discover -s tests",
        "#",
        "# ✅ CORRECT (pytest handles both):",
        "#    coverage run -m pytest tests/",
        "#",
        "# Test stages run in dependency order:",
        "#   smoke → unit → integration → [regression, behavioral, performance]",
        "#                              → coverage-report",
        "#",
        "# Each stage runs specific test directories/files to avoid duplication.",
        "# The final coverage-report stage runs ALL tests once for the combined number.",
        "# =============================================================================",
        ""
      ],
      "lines_removed": [],
      "context_before": [
        "name: CI - Test Suite",
        ""
      ],
      "context_after": [
        "on:",
        "  push:",
        "  pull_request:",
        "    branches: [ main ]",
        "  workflow_dispatch:  # Allow manual triggering",
        "",
        "concurrency:",
        "  group: ${{ github.workflow }}-${{ github.ref }}",
        "  cancel-in-progress: true",
        ""
      ],
      "change_type": "add"
    },
    {
      "file": "workflows/ci.yml b/.github/workflows/ci.yml",
      "function": "jobs:",
      "start_line": 234,
      "lines_added": [
        "        # ⚠️  IMPORTANT: DO NOT add duplicate test runs here!",
        "        #",
        "        # Pytest runs unittest-based tests natively - no need to run both.",
        "        # Running tests twice doubles CI time (from ~7min to ~15min+).",
        "        #",
        "        # If you need to add tests, add them to the appropriate stage above",
        "        # (unit-tests, integration-tests, etc.) NOT here.",
        "        #",
        "        # This job combines coverage from artifacts, then runs a single",
        "        # comprehensive pass for the final coverage number.",
        "",
        "        # Single test run - pytest handles both pytest AND unittest style tests"
      ],
      "lines_removed": [
        "        # Run pytest-based tests (tests/unit/, tests/smoke/, etc.)",
        "        # Append unittest-based legacy tests",
        "        coverage run --append --source=cortical -m unittest discover -s tests -p \"test_*.py\" -v",
        ""
      ],
      "context_before": [
        "",
        "    - name: Download integration coverage",
        "      uses: actions/download-artifact@v4",
        "      with:",
        "        name: coverage-integration",
        "        path: .",
        "",
        "    - name: Generate combined coverage report",
        "      run: |",
        "        echo \"=== Combined Coverage Report ===\""
      ],
      "context_after": [
        "        coverage run --source=cortical -m pytest tests/ -v --ignore=tests/performance/",
        "",
        "        coverage report -m --include=\"cortical/*\"",
        "        coverage xml -o coverage.xml",
        "",
        "        # Check threshold",
        "        coverage report --fail-under=89 --include=\"cortical/*\"",
        "",
        "    - name: Upload final coverage report",
        "      uses: actions/upload-artifact@v4",
        "      with:",
        "        name: coverage-report"
      ],
      "change_type": "modify"
    },
    {
      "file": "CLAUDE.md",
      "function": "class TestYourFeature(unittest.TestCase):",
      "start_line": 577,
      "lines_added": [
        "### CI/CD Best Practices",
        "",
        "**CRITICAL: Pytest runs unittest-based tests natively!**",
        "",
        "Never run both pytest and unittest on the same test files - this doubles CI time:",
        "",
        "```bash",
        "# ❌ WRONG - runs tests twice (doubles CI time from ~7min to ~15min+)",
        "coverage run -m pytest tests/",
        "coverage run --append -m unittest discover -s tests",
        "",
        "# ✅ CORRECT - pytest handles both pytest AND unittest style tests",
        "coverage run -m pytest tests/",
        "```",
        "",
        "**Why this matters:**",
        "- All `test_*.py` files using `unittest.TestCase` are discovered and run by pytest",
        "- Running unittest separately re-runs the exact same tests",
        "- With 3000+ tests and coverage overhead, this can add 10+ minutes to CI",
        "",
        "**When modifying `.github/workflows/ci.yml`:**",
        "1. Read the header comment explaining the test architecture",
        "2. Add new tests to the appropriate stage (smoke, unit, integration, etc.)",
        "3. Never add duplicate test runners in the coverage-report job",
        "4. When in doubt, run locally first: `time python -m pytest tests/ -v`",
        ""
      ],
      "lines_removed": [],
      "context_before": [
        "| `fresh_processor` | function | Empty processor for isolated tests |",
        "| `small_corpus_docs` | function | Raw document dict |",
        "",
        "**Always test:**",
        "- Empty corpus case",
        "- Single document case",
        "- Multiple documents case",
        "- Edge cases specific to your feature",
        "- Add regression test if fixing a bug",
        ""
      ],
      "context_after": [
        "---",
        "",
        "## Common Tasks",
        "",
        "### Adding a New Analysis Function",
        "",
        "1. Add function to `analysis.py` with proper signature:",
        "   ```python",
        "   def compute_your_analysis(",
        "       layers: Dict[CorticalLayer, HierarchicalLayer],"
      ],
      "change_type": "add"
    }
  ],
  "hour_of_day": 10,
  "day_of_week": "Saturday",
  "seconds_since_last_commit": -182825,
  "is_merge": false,
  "is_initial": false,
  "parent_count": 1,
  "session_id": null,
  "related_chats": [],
  "ci_result": null,
  "reverted": false,
  "amended": false
}