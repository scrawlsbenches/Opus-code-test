{
  "hash": "6f87e051afb7bd61293114407b0f9499c78965d6",
  "message": "Add unit tests for showcase.py and ask_codebase.py",
  "author": "Claude",
  "timestamp": "2025-12-11 02:01:58 +0000",
  "branch": "claude/multi-index-design-DvifZ",
  "files_changed": [
    "tests/test_ask_codebase.py",
    "tests/test_showcase.py"
  ],
  "insertions": 329,
  "deletions": 0,
  "hunks": [
    {
      "file": "tests/test_ask_codebase.py",
      "function": null,
      "start_line": 0,
      "lines_added": [
        "\"\"\"",
        "Tests for scripts/ask_codebase.py - CodebaseQA class and utilities.",
        "\"\"\"",
        "",
        "import unittest",
        "import sys",
        "from pathlib import Path",
        "",
        "# Add parent and scripts directories to path",
        "sys.path.insert(0, str(Path(__file__).parent.parent))",
        "sys.path.insert(0, str(Path(__file__).parent.parent / 'scripts'))",
        "",
        "from cortical.processor import CorticalTextProcessor",
        "from ask_codebase import (",
        "    CodebaseQA,",
        "    find_line_number,",
        "    format_reference,",
        "    get_doc_type_emoji",
        ")",
        "",
        "",
        "class TestUtilityFunctions(unittest.TestCase):",
        "    \"\"\"Tests for utility functions.\"\"\"",
        "",
        "    def test_find_line_number_start(self):",
        "        \"\"\"Test line number at start of document.\"\"\"",
        "        content = \"line1\\nline2\\nline3\"",
        "        self.assertEqual(find_line_number(content, 0), 1)",
        "",
        "    def test_find_line_number_second_line(self):",
        "        \"\"\"Test line number for second line.\"\"\"",
        "        content = \"line1\\nline2\\nline3\"",
        "        self.assertEqual(find_line_number(content, 6), 2)",
        "",
        "    def test_find_line_number_third_line(self):",
        "        \"\"\"Test line number for third line.\"\"\"",
        "        content = \"line1\\nline2\\nline3\"",
        "        self.assertEqual(find_line_number(content, 12), 3)",
        "",
        "    def test_format_reference(self):",
        "        \"\"\"Test reference formatting.\"\"\"",
        "        ref = format_reference(\"cortical/processor.py\", 42)",
        "        self.assertEqual(ref, \"cortical/processor.py:42\")",
        "",
        "    def test_get_doc_type_emoji_markdown(self):",
        "        \"\"\"Test emoji for markdown files.\"\"\"",
        "        self.assertEqual(get_doc_type_emoji(\"README.md\"), \"ðŸ“–\")",
        "        self.assertEqual(get_doc_type_emoji(\"docs/guide.md\"), \"ðŸ“–\")",
        "",
        "    def test_get_doc_type_emoji_test(self):",
        "        \"\"\"Test emoji for test files.\"\"\"",
        "        self.assertEqual(get_doc_type_emoji(\"tests/test_processor.py\"), \"ðŸ§ª\")",
        "        self.assertEqual(get_doc_type_emoji(\"tests/test_analysis.py\"), \"ðŸ§ª\")",
        "",
        "    def test_get_doc_type_emoji_code(self):",
        "        \"\"\"Test emoji for code files.\"\"\"",
        "        self.assertEqual(get_doc_type_emoji(\"cortical/processor.py\"), \"ðŸ’»\")",
        "        self.assertEqual(get_doc_type_emoji(\"scripts/index.py\"), \"ðŸ’»\")",
        "",
        "",
        "class TestCodebaseQA(unittest.TestCase):",
        "    \"\"\"Tests for the CodebaseQA class.\"\"\"",
        "",
        "    @classmethod",
        "    def setUpClass(cls):",
        "        \"\"\"Set up processor with test documents.\"\"\"",
        "        cls.processor = CorticalTextProcessor()",
        "",
        "        # Add test documents",
        "        cls.processor.process_document(",
        "            \"processor.py\",",
        "            \"\"\"",
        "            The CorticalTextProcessor is the main API for text analysis.",
        "            It uses PageRank for term importance and TF-IDF for relevance.",
        "            Query expansion adds related terms to improve recall.",
        "            \"\"\"",
        "        )",
        "        cls.processor.process_document(",
        "            \"README.md\",",
        "            \"\"\"",
        "            # Cortical Text Processor",
        "",
        "            A hierarchical text analysis library inspired by visual cortex.",
        "",
        "            ## Features",
        "            - PageRank for centrality",
        "            - TF-IDF for relevance",
        "            - Query expansion",
        "            \"\"\"",
        "        )",
        "        cls.processor.process_document(",
        "            \"tests/test_processor.py\",",
        "            \"\"\"",
        "            import unittest",
        "",
        "            class TestProcessor(unittest.TestCase):",
        "                def test_pagerank(self):",
        "                    processor = CorticalTextProcessor()",
        "                    processor.compute_all()",
        "            \"\"\"",
        "        )",
        "",
        "        cls.processor.compute_all()",
        "        cls.qa = CodebaseQA(cls.processor)",
        "",
        "    def test_find_relevant_passages(self):",
        "        \"\"\"Test finding relevant passages.\"\"\"",
        "        passages = self.qa.find_relevant_passages(\"PageRank algorithm\", top_n=2)",
        "",
        "        self.assertIsInstance(passages, list)",
        "        self.assertGreater(len(passages), 0)",
        "",
        "        # Each passage should be (text, reference, line_num, score)",
        "        passage = passages[0]",
        "        self.assertEqual(len(passage), 4)",
        "        self.assertIsInstance(passage[0], str)  # text",
        "        self.assertIsInstance(passage[1], str)  # reference",
        "        self.assertIsInstance(passage[2], int)  # line_num",
        "        self.assertIsInstance(passage[3], float)  # score",
        "",
        "    def test_find_relevant_passages_empty_query(self):",
        "        \"\"\"Test with empty query.\"\"\"",
        "        passages = self.qa.find_relevant_passages(\"\", top_n=2)",
        "        self.assertIsInstance(passages, list)",
        "",
        "    def test_format_answer_with_passages(self):",
        "        \"\"\"Test answer formatting with passages.\"\"\"",
        "        passages = self.qa.find_relevant_passages(\"PageRank\", top_n=2)",
        "        answer = self.qa.format_answer(\"What is PageRank?\", passages)",
        "",
        "        self.assertIsInstance(answer, str)",
        "        self.assertIn(\"PageRank\", answer)",
        "        self.assertIn(\"Relevant Context\", answer)",
        "",
        "    def test_format_answer_empty_passages(self):",
        "        \"\"\"Test answer formatting with no passages.\"\"\"",
        "        answer = self.qa.format_answer(\"What is XYZ123?\", [])",
        "",
        "        self.assertIn(\"No relevant passages found\", answer)",
        "",
        "    def test_format_answer_shows_sources(self):",
        "        \"\"\"Test that sources are shown.\"\"\"",
        "        passages = self.qa.find_relevant_passages(\"PageRank\", top_n=2)",
        "        answer = self.qa.format_answer(\"What is PageRank?\", passages, show_sources=True)",
        "",
        "        self.assertIn(\"Sources\", answer)",
        "",
        "    def test_format_answer_hides_sources(self):",
        "        \"\"\"Test that sources can be hidden.\"\"\"",
        "        passages = self.qa.find_relevant_passages(\"PageRank\", top_n=2)",
        "        answer = self.qa.format_answer(\"What is PageRank?\", passages, show_sources=False)",
        "",
        "        self.assertNotIn(\"Sources:\", answer)",
        "",
        "    def test_answer_method(self):",
        "        \"\"\"Test the main answer method.\"\"\"",
        "        answer = self.qa.answer(\"How does query expansion work?\")",
        "",
        "        self.assertIsInstance(answer, str)",
        "        self.assertGreater(len(answer), 0)",
        "",
        "    def test_answer_detects_conceptual_query(self):",
        "        \"\"\"Test that conceptual queries are detected.\"\"\"",
        "        answer = self.qa.answer(\"What is PageRank?\")",
        "        self.assertIn(\"conceptual\", answer.lower())",
        "",
        "    def test_answer_detects_implementation_query(self):",
        "        \"\"\"Test that implementation queries are detected.\"\"\"",
        "        answer = self.qa.answer(\"compute pagerank damping factor\")",
        "        self.assertIn(\"implementation\", answer.lower())",
        "",
        "",
        "class TestCodebaseQAEmpty(unittest.TestCase):",
        "    \"\"\"Tests for CodebaseQA with empty processor.\"\"\"",
        "",
        "    def test_empty_processor(self):",
        "        \"\"\"Test with empty processor.\"\"\"",
        "        processor = CorticalTextProcessor()",
        "        qa = CodebaseQA(processor)",
        "",
        "        passages = qa.find_relevant_passages(\"anything\", top_n=2)",
        "        self.assertEqual(passages, [])",
        "",
        "    def test_empty_processor_answer(self):",
        "        \"\"\"Test answer with empty processor.\"\"\"",
        "        processor = CorticalTextProcessor()",
        "        qa = CodebaseQA(processor)",
        "",
        "        answer = qa.answer(\"How does X work?\")",
        "        self.assertIn(\"No relevant passages\", answer)",
        "",
        "",
        "if __name__ == '__main__':",
        "    unittest.main()"
      ],
      "lines_removed": [],
      "context_before": [],
      "context_after": [],
      "change_type": "add"
    },
    {
      "file": "tests/test_showcase.py",
      "function": null,
      "start_line": 0,
      "lines_added": [
        "\"\"\"",
        "Tests for showcase.py - Timer class and utility functions.",
        "\"\"\"",
        "",
        "import unittest",
        "import time",
        "import sys",
        "from pathlib import Path",
        "",
        "# Add parent directory to path for imports",
        "sys.path.insert(0, str(Path(__file__).parent.parent))",
        "",
        "from showcase import Timer, print_header, print_subheader, render_bar",
        "",
        "",
        "class TestTimer(unittest.TestCase):",
        "    \"\"\"Tests for the Timer class.\"\"\"",
        "",
        "    def test_timer_start_stop(self):",
        "        \"\"\"Test basic start/stop timing.\"\"\"",
        "        timer = Timer()",
        "        timer.start('test_op')",
        "        time.sleep(0.01)  # Small delay",
        "        elapsed = timer.stop()",
        "",
        "        self.assertGreater(elapsed, 0.005)",
        "        self.assertLess(elapsed, 0.1)",
        "",
        "    def test_timer_records_time(self):",
        "        \"\"\"Test that timer records time in times dict.\"\"\"",
        "        timer = Timer()",
        "        timer.start('operation')",
        "        time.sleep(0.01)",
        "        timer.stop()",
        "",
        "        self.assertIn('operation', timer.times)",
        "        self.assertGreater(timer.times['operation'], 0)",
        "",
        "    def test_timer_get(self):",
        "        \"\"\"Test get method returns recorded time.\"\"\"",
        "        timer = Timer()",
        "        timer.start('op1')",
        "        time.sleep(0.01)",
        "        timer.stop()",
        "",
        "        recorded = timer.get('op1')",
        "        self.assertGreater(recorded, 0)",
        "        self.assertEqual(recorded, timer.times['op1'])",
        "",
        "    def test_timer_get_missing(self):",
        "        \"\"\"Test get returns 0 for unrecorded operation.\"\"\"",
        "        timer = Timer()",
        "        self.assertEqual(timer.get('nonexistent'), 0)",
        "",
        "    def test_timer_multiple_operations(self):",
        "        \"\"\"Test timing multiple operations.\"\"\"",
        "        timer = Timer()",
        "",
        "        timer.start('op1')",
        "        time.sleep(0.01)",
        "        timer.stop()",
        "",
        "        timer.start('op2')",
        "        time.sleep(0.02)",
        "        timer.stop()",
        "",
        "        self.assertIn('op1', timer.times)",
        "        self.assertIn('op2', timer.times)",
        "        self.assertGreater(timer.get('op2'), timer.get('op1'))",
        "",
        "    def test_timer_overwrite(self):",
        "        \"\"\"Test that timing same operation overwrites previous.\"\"\"",
        "        timer = Timer()",
        "",
        "        timer.start('op')",
        "        time.sleep(0.01)",
        "        timer.stop()",
        "        first_time = timer.get('op')",
        "",
        "        timer.start('op')",
        "        time.sleep(0.02)",
        "        timer.stop()",
        "        second_time = timer.get('op')",
        "",
        "        # Second time should overwrite and be longer",
        "        self.assertNotEqual(first_time, second_time)",
        "",
        "",
        "class TestRenderBar(unittest.TestCase):",
        "    \"\"\"Tests for the render_bar function.\"\"\"",
        "",
        "    def test_render_bar_full(self):",
        "        \"\"\"Test render_bar at 100%.\"\"\"",
        "        bar = render_bar(100, 100, width=10)",
        "        self.assertEqual(bar, \"â–ˆ\" * 10)",
        "",
        "    def test_render_bar_empty(self):",
        "        \"\"\"Test render_bar at 0%.\"\"\"",
        "        bar = render_bar(0, 100, width=10)",
        "        self.assertEqual(bar, \"â–‘\" * 10)",
        "",
        "    def test_render_bar_half(self):",
        "        \"\"\"Test render_bar at 50%.\"\"\"",
        "        bar = render_bar(50, 100, width=10)",
        "        self.assertEqual(bar, \"â–ˆ\" * 5 + \"â–‘\" * 5)",
        "",
        "    def test_render_bar_zero_max(self):",
        "        \"\"\"Test render_bar with zero max value.\"\"\"",
        "        bar = render_bar(50, 0, width=10)",
        "        self.assertEqual(bar, \" \" * 10)",
        "",
        "    def test_render_bar_custom_width(self):",
        "        \"\"\"Test render_bar with custom width.\"\"\"",
        "        bar = render_bar(75, 100, width=20)",
        "        self.assertEqual(len(bar), 20)",
        "        self.assertEqual(bar.count(\"â–ˆ\"), 15)",
        "",
        "",
        "class TestPrintFunctions(unittest.TestCase):",
        "    \"\"\"Tests for print helper functions.\"\"\"",
        "",
        "    def test_print_header_returns_none(self):",
        "        \"\"\"Test print_header doesn't raise.\"\"\"",
        "        # Just verify it doesn't raise",
        "        result = print_header(\"Test Header\")",
        "        self.assertIsNone(result)",
        "",
        "    def test_print_subheader_returns_none(self):",
        "        \"\"\"Test print_subheader doesn't raise.\"\"\"",
        "        result = print_subheader(\"Test Subheader\")",
        "        self.assertIsNone(result)",
        "",
        "",
        "if __name__ == '__main__':",
        "    unittest.main()"
      ],
      "lines_removed": [],
      "context_before": [],
      "context_after": [],
      "change_type": "add"
    }
  ],
  "hour_of_day": 2,
  "day_of_week": "Thursday",
  "seconds_since_last_commit": -387770,
  "is_merge": false,
  "is_initial": false,
  "parent_count": 1,
  "session_id": null,
  "related_chats": [],
  "ci_result": null,
  "reverted": false,
  "amended": false
}