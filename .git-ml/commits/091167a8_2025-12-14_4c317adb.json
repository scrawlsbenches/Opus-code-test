{
  "hash": "091167a86afe4c1066e4219a442c8e11d3e0a734",
  "message": "docs: Add MCP server security model documentation (SEC-006)",
  "author": "Claude",
  "timestamp": "2025-12-14 11:30:23 +0000",
  "branch": "claude/multi-index-design-DvifZ",
  "files_changed": [
    "docs/README.md",
    "docs/mcp-security.md",
    "tasks/2025-12-14_11-15-01_41d5.json"
  ],
  "insertions": 256,
  "deletions": 25,
  "hunks": [
    {
      "file": "docs/README.md",
      "function": "Welcome to the Cortical Text Processor documentation. This index provides naviga",
      "start_line": 78,
      "lines_added": [
        "### Security",
        "",
        "| Document | Purpose |",
        "|----------|---------|",
        "| [security-knowledge-transfer.md](security-knowledge-transfer.md) | Full security review and findings |",
        "| [mcp-security.md](mcp-security.md) | MCP server security model and deployment |",
        ""
      ],
      "lines_removed": [],
      "context_before": [
        "| [dogfooding.md](dogfooding.md) | Using the system to test itself |",
        "| [dogfooding-checklist.md](dogfooding-checklist.md) | Systematic dog-fooding checklist |",
        "",
        "### AI Agent Resources",
        "",
        "| Document | Purpose |",
        "|----------|---------|",
        "| [claude-usage.md](claude-usage.md) | Guide for Claude agents using the system |",
        "| [cli-wrapper-guide.md](cli-wrapper-guide.md) | CLI wrapper for AI assistants |",
        ""
      ],
      "context_after": [
        "---",
        "",
        "## Additional Resources",
        "",
        "- **[CLAUDE.md](../CLAUDE.md)** - Main development guide (in repo root)",
        "- **[CONTRIBUTING.md](../CONTRIBUTING.md)** - How to contribute",
        "- **[TASK_LIST.md](../TASK_LIST.md)** - Active task backlog",
        "- **[README.md](../README.md)** - Project overview",
        "",
        "---"
      ],
      "change_type": "add"
    },
    {
      "file": "docs/mcp-security.md",
      "function": null,
      "start_line": 0,
      "lines_added": [
        "# MCP Server Security Model",
        "",
        "This document describes the security considerations for the Cortical Text Processor MCP (Model Context Protocol) server.",
        "",
        "## Overview",
        "",
        "The MCP server (`cortical/mcp_server.py`) provides an interface for AI agents to interact with the Cortical Text Processor. It exposes five tools for semantic search, passage retrieval, query expansion, corpus statistics, and document indexing.",
        "",
        "## Exposed Capabilities",
        "",
        "| Tool | Operation | Risk Level | Notes |",
        "|------|-----------|------------|-------|",
        "| `search` | Read-only query | Low | Returns document IDs and scores |",
        "| `passages` | Read-only query | Low | Returns text passages from corpus |",
        "| `expand_query` | Read-only query | Low | Returns expansion terms |",
        "| `corpus_stats` | Read-only stats | Low | Returns aggregate statistics |",
        "| `add_document` | Write operation | Medium | Adds documents to corpus |",
        "",
        "### Tool Details",
        "",
        "#### `search(query, top_n)`",
        "- **Input validation**: Query must be non-empty string; `top_n >= 1`",
        "- **Output**: Document IDs and relevance scores",
        "- **Risk**: Information disclosure if corpus contains sensitive data",
        "",
        "#### `passages(query, top_n, chunk_size)`",
        "- **Input validation**: Query must be non-empty string; `top_n >= 1`",
        "- **Output**: Actual text content from documents",
        "- **Risk**: Higher information disclosure risk than `search`",
        "",
        "#### `expand_query(query, max_expansions)`",
        "- **Input validation**: Query must be non-empty string; `max_expansions >= 1`",
        "- **Output**: Related terms and weights",
        "- **Risk**: Low - only exposes term relationships",
        "",
        "#### `corpus_stats()`",
        "- **Input validation**: None (no parameters)",
        "- **Output**: Document counts, layer statistics",
        "- **Risk**: Metadata disclosure only",
        "",
        "#### `add_document(doc_id, content, recompute)`",
        "- **Input validation**: `doc_id` non-empty string; `content` must be string; `recompute` in {'none', 'tfidf', 'full'}",
        "- **Output**: Processing statistics",
        "- **Risk**:",
        "  - Corpus pollution (malicious content injection)",
        "  - Resource exhaustion (large documents, frequent additions)",
        "  - Overwriting existing documents (no duplicate protection)",
        "",
        "## Trust Model",
        "",
        "### Who Can Call the Server",
        "",
        "The MCP server uses stdio transport by default, meaning:",
        "",
        "1. **Local Execution**: The server runs as a local process",
        "2. **No Network Exposure**: stdio transport doesn't listen on network ports",
        "3. **Caller is Trusted**: The calling process (typically an AI assistant) has full access",
        "",
        "### Trust Assumptions",
        "",
        "| Assumption | Implication |",
        "|------------|-------------|",
        "| Caller is authorized | No authentication mechanism |",
        "| Corpus content is not sensitive | Results returned without filtering |",
        "| Input is well-formed | Basic validation only |",
        "| Single-tenant usage | No multi-user isolation |",
        "",
        "### Security Boundary",
        "",
        "```",
        "┌─────────────────────────────────────────────────────────┐",
        "│                    AI Assistant Process                  │",
        "│  ┌─────────────────┐      ┌─────────────────────────┐   │",
        "│  │   MCP Client    │──────│   Cortical MCP Server   │   │",
        "│  └─────────────────┘ stdio└─────────────────────────┘   │",
        "│                                      │                   │",
        "│                            ┌─────────▼─────────┐        │",
        "│                            │ CorticalTextProc  │        │",
        "│                            │    (in-memory)    │        │",
        "│                            └───────────────────┘        │",
        "└─────────────────────────────────────────────────────────┘",
        "```",
        "",
        "The security boundary is at the process level. Anyone who can communicate with the stdio interface has full access.",
        "",
        "## Input Validation",
        "",
        "### Current Validation",
        "",
        "All tools perform basic input validation:",
        "",
        "```python",
        "# String validation",
        "if not query or not query.strip():",
        "    return {\"error\": \"Query must be a non-empty string\", ...}",
        "",
        "# Numeric validation",
        "if top_n < 1:",
        "    return {\"error\": \"top_n must be at least 1\", ...}",
        "",
        "# Enum validation",
        "valid_recompute = {'none', 'tfidf', 'full'}",
        "if recompute not in valid_recompute:",
        "    return {\"error\": f\"recompute must be one of {valid_recompute}\", ...}",
        "```",
        "",
        "### Validation Gaps",
        "",
        "| Gap | Risk | Mitigation |",
        "|-----|------|------------|",
        "| No max length for `content` | Memory exhaustion | Add content size limit |",
        "| No max length for `query` | Performance impact | Add query length limit |",
        "| No rate limiting | Resource exhaustion | Implement rate limiting |",
        "| No `doc_id` format validation | Potential path issues | Validate `doc_id` characters |",
        "",
        "## Resource Considerations",
        "",
        "### Memory Usage",
        "",
        "The processor stores all documents in memory:",
        "",
        "- **Per document**: ~10-100KB depending on content",
        "- **Index structures**: ~5x document size",
        "- **No memory limits**: Can exhaust system memory",
        "",
        "### CPU Usage",
        "",
        "Resource-intensive operations:",
        "",
        "| Operation | CPU Impact | Notes |",
        "|-----------|------------|-------|",
        "| `add_document` with `recompute='full'` | High | Triggers full recomputation |",
        "| `search` with large corpus | Medium | Iterates all documents |",
        "| `passages` | Medium | Text chunking and scoring |",
        "",
        "## Rate Limiting Considerations",
        "",
        "The MCP server does not implement rate limiting. For production deployments, consider:",
        "",
        "### Recommended Limits",
        "",
        "| Metric | Suggested Limit | Rationale |",
        "|--------|-----------------|-----------|",
        "| Requests per minute | 60 | Prevent runaway queries |",
        "| Document additions per hour | 100 | Limit corpus growth |",
        "| Max document size | 1 MB | Prevent memory exhaustion |",
        "| Max query length | 1000 chars | Prevent complex queries |",
        "| Max concurrent requests | 5 | Limit resource contention |",
        "",
        "### Implementation Options",
        "",
        "1. **Wrapper Rate Limiter**: Add rate limiting wrapper around tools",
        "2. **External Proxy**: Use API gateway with rate limiting",
        "3. **Token Bucket**: Implement in-memory token bucket",
        "",
        "## Recommended Deployment Configurations",
        "",
        "### Development / Local Use",
        "",
        "```bash",
        "# Default configuration - suitable for local development",
        "python -m cortical.mcp_server",
        "```",
        "",
        "- Trust model: Single user, full trust",
        "- Network: stdio only (no network exposure)",
        "- Corpus: Ephemeral or local file",
        "",
        "### Production Considerations",
        "",
        "If deploying the MCP server in a production context:",
        "",
        "1. **Do not expose to untrusted networks**",
        "   - MCP over stdio is designed for local use",
        "   - No authentication or authorization",
        "",
        "2. **Corpus sensitivity**",
        "   - Assume all corpus content can be returned to callers",
        "   - Do not index sensitive/confidential documents unless callers are authorized",
        "",
        "3. **Resource isolation**",
        "   - Run in container with memory limits",
        "   - Set CPU quotas",
        "   - Monitor resource usage",
        "",
        "4. **Logging and auditing**",
        "   - Enable `CORTICAL_LOG_LEVEL=DEBUG` for request logging",
        "   - Log all `add_document` calls for audit trail",
        "",
        "### Environment Variables",
        "",
        "| Variable | Purpose | Default |",
        "|----------|---------|---------|",
        "| `CORTICAL_CORPUS_PATH` | Path to saved corpus | None (empty corpus) |",
        "| `CORTICAL_LOG_LEVEL` | Logging verbosity | INFO |",
        "",
        "## Security Checklist",
        "",
        "Before deploying the MCP server:",
        "",
        "- [ ] Verify corpus content is appropriate for callers",
        "- [ ] Set memory limits on container/process",
        "- [ ] Enable logging for audit trail",
        "- [ ] Consider document size limits for `add_document`",
        "- [ ] Review if `add_document` capability is needed",
        "- [ ] Test with representative workloads",
        "",
        "## Related Documentation",
        "",
        "- [Security Knowledge Transfer](security-knowledge-transfer.md) - Full security review",
        "- [README Security Section](../README.md#security-considerations) - Pickle warnings",
        "- [Architecture](architecture.md) - System design"
      ],
      "lines_removed": [],
      "context_before": [],
      "context_after": [],
      "change_type": "add"
    },
    {
      "file": "tasks/2025-12-14_11-15-01_41d5.json",
      "function": null,
      "start_line": 1,
      "lines_added": [
        "  \"saved_at\": \"2025-12-14T11:30:12.719271\",",
        "      \"status\": \"completed\",",
        "      \"updated_at\": \"2025-12-14T11:28:39.474962\",",
        "      \"completed_at\": \"2025-12-14T11:28:39.474962\",",
        "      \"retrospective\": {",
        "        \"notes\": \"Implemented in commit 90b989f\"",
        "      }",
        "      \"status\": \"completed\",",
        "      \"updated_at\": \"2025-12-14T11:28:39.474977\",",
        "      \"completed_at\": \"2025-12-14T11:28:39.474977\",",
        "      \"retrospective\": {",
        "        \"notes\": \"Implemented in commit 90b989f\"",
        "      }"
      ],
      "lines_removed": [
        "  \"saved_at\": \"2025-12-14T11:15:01.282011\",",
        "      \"status\": \"pending\",",
        "      \"updated_at\": null,",
        "      \"completed_at\": null,",
        "      \"retrospective\": null",
        "      \"status\": \"pending\",",
        "      \"updated_at\": null,",
        "      \"completed_at\": null,",
        "      \"retrospective\": null"
      ],
      "context_before": [
        "{",
        "  \"version\": 1,",
        "  \"session_id\": \"41d5\",",
        "  \"started_at\": \"2025-12-14T11:15:01.281778\","
      ],
      "context_after": [
        "  \"tasks\": [",
        "    {",
        "      \"id\": \"T-20251214-111501-41d5-001\",",
        "      \"title\": \"SEC-001: Add pickle security warning to README\",",
        "      \"priority\": \"high\",",
        "      \"category\": \"security\",",
        "      \"description\": \"Add a security warning to README.md about pickle deserialization risks.\\n\\nLocation: cortical/persistence.py:156 uses pickle.load() which can execute arbitrary code.\\n\\nWarning should include:\\n- Risk explanation (RCE via malicious pickle files)\\n- Recommendation to use JSON format (StateLoader) for untrusted sources\\n- Link to Python pickle documentation security warning\\n\\nEffort: 30 minutes\",",
        "      \"depends_on\": [],",
        "      \"effort\": \"small\",",
        "      \"created_at\": \"2025-12-14T11:15:01.281819\",",
        "      \"context\": {",
        "        \"files\": [",
        "          \"README.md\",",
        "          \"cortical/persistence.py\"",
        "        ],",
        "        \"line\": 156",
        "      },",
        "    },",
        "    {",
        "      \"id\": \"T-20251214-111501-41d5-002\",",
        "      \"title\": \"SEC-002: Add Bandit SAST to CI pipeline\",",
        "      \"priority\": \"high\",",
        "      \"category\": \"security\",",
        "      \"description\": \"Add Bandit (Python static analysis security tool) to CI workflow.\\n\\nAdd to .github/workflows/ci.yml:\\n```yaml\\nsecurity-scan:\\n  name: \\\"Security Scan\\\"\\n  runs-on: ubuntu-latest\\n  steps:\\n  - uses: actions/checkout@v4\\n  - name: Set up Python\\n    uses: actions/setup-python@v5\\n    with:\\n      python-version: '3.11'\\n  - name: Run Bandit\\n    run: |\\n      pip install bandit\\n      bandit -r cortical/ -ll -f txt\\n```\\n\\nEffort: 1 hour\",",
        "      \"depends_on\": [],",
        "      \"effort\": \"small\",",
        "      \"created_at\": \"2025-12-14T11:15:01.281828\",",
        "      \"context\": {",
        "        \"files\": [",
        "          \".github/workflows/ci.yml\"",
        "        ]",
        "      },",
        "    },",
        "    {",
        "      \"id\": \"T-20251214-111501-41d5-003\",",
        "      \"title\": \"SEC-003: Implement pickle HMAC verification\",",
        "      \"status\": \"pending\",",
        "      \"priority\": \"medium\",",
        "      \"category\": \"security\",",
        "      \"description\": \"Add HMAC signature verification before loading pickle files.\\n\\nImplementation:\\n1. Generate HMAC when saving: hmac.new(secret_key, pickle_data, 'sha256')\\n2. Store signature alongside pickle file (.pkl.sig)\\n3. Verify signature before pickle.load()\\n4. Reject files with invalid/missing signatures\\n\\nThis prevents loading tampered pickle files even from trusted sources.\\n\\nEffort: 4 hours\",",
        "      \"depends_on\": [],",
        "      \"effort\": \"medium\","
      ],
      "change_type": "modify"
    },
    {
      "file": "tasks/2025-12-14_11-15-01_41d5.json",
      "function": null,
      "start_line": 62,
      "lines_added": [
        "      \"status\": \"completed\",",
        "      \"updated_at\": \"2025-12-14T11:28:39.474979\",",
        "      \"completed_at\": \"2025-12-14T11:28:39.474979\",",
        "      \"retrospective\": {",
        "        \"notes\": \"Implemented in commit 90b989f\"",
        "      }",
        "      \"status\": \"completed\",",
        "      \"updated_at\": \"2025-12-14T11:28:39.474982\",",
        "      \"completed_at\": \"2025-12-14T11:28:39.474982\",",
        "      \"retrospective\": {",
        "        \"notes\": \"Implemented in commit 90b989f\"",
        "      }",
        "      \"status\": \"completed\",",
        "      \"updated_at\": \"2025-12-14T11:30:12.719118\",",
        "      \"completed_at\": \"2025-12-14T11:30:12.719118\",",
        "      \"retrospective\": {",
        "        \"notes\": \"Created docs/mcp-security.md\"",
        "      }"
      ],
      "lines_removed": [
        "      \"status\": \"pending\",",
        "      \"updated_at\": null,",
        "      \"completed_at\": null,",
        "      \"retrospective\": null",
        "      \"status\": \"pending\",",
        "      \"updated_at\": null,",
        "      \"completed_at\": null,",
        "      \"retrospective\": null",
        "      \"status\": \"pending\",",
        "      \"updated_at\": null,",
        "      \"completed_at\": null,",
        "      \"retrospective\": null"
      ],
      "context_before": [
        "        ],",
        "        \"methods\": [",
        "          \"load_processor()\"",
        "        ]",
        "      },",
        "      \"retrospective\": null",
        "    },",
        "    {",
        "      \"id\": \"T-20251214-111501-41d5-004\",",
        "      \"title\": \"SEC-004: Add pip-audit dependency scanning to CI\","
      ],
      "context_after": [
        "      \"priority\": \"medium\",",
        "      \"category\": \"security\",",
        "      \"description\": \"Add pip-audit to check for known vulnerabilities in dependencies.\\n\\nAdd step to security-scan job:\\n```yaml\\n- name: Check Dependencies\\n  run: |\\n    pip install pip-audit\\n    pip install -e \\\".[dev]\\\"\\n    pip-audit --desc || echo \\\"Review required\\\"\\n```\\n\\nEffort: 1 hour\",",
        "      \"depends_on\": [],",
        "      \"effort\": \"small\",",
        "      \"created_at\": \"2025-12-14T11:15:01.281842\",",
        "      \"context\": {",
        "        \"files\": [",
        "          \".github/workflows/ci.yml\"",
        "        ]",
        "      },",
        "    },",
        "    {",
        "      \"id\": \"T-20251214-111501-41d5-005\",",
        "      \"title\": \"SEC-005: Add detect-secrets to CI pipeline\",",
        "      \"priority\": \"medium\",",
        "      \"category\": \"security\",",
        "      \"description\": \"Add detect-secrets to scan for accidentally committed secrets.\\n\\nAdd step to security-scan job:\\n```yaml\\n- name: Scan for Secrets\\n  run: |\\n    pip install detect-secrets\\n    detect-secrets scan --all-files --exclude-files '\\\\.git/.*'\\n```\\n\\nEffort: 1 hour\",",
        "      \"depends_on\": [],",
        "      \"effort\": \"small\",",
        "      \"created_at\": \"2025-12-14T11:15:01.281848\",",
        "      \"context\": {",
        "        \"files\": [",
        "          \".github/workflows/ci.yml\"",
        "        ]",
        "      },",
        "    },",
        "    {",
        "      \"id\": \"T-20251214-111501-41d5-006\",",
        "      \"title\": \"SEC-006: Document MCP server security model\",",
        "      \"priority\": \"medium\",",
        "      \"category\": \"security\",",
        "      \"description\": \"Create security documentation for the MCP server integration.\\n\\nDocument:\\n- What capabilities the MCP server exposes\\n- Input validation performed\\n- Trust model (who can call the server)\\n- Rate limiting considerations\\n- Recommended deployment configurations\\n\\nCreate: docs/security.md or docs/mcp-security.md\\n\\nEffort: 2 hours\",",
        "      \"depends_on\": [],",
        "      \"effort\": \"small\",",
        "      \"created_at\": \"2025-12-14T11:15:01.281854\",",
        "      \"context\": {",
        "        \"files\": [",
        "          \"cortical/mcp_server.py\",",
        "          \"docs/\"",
        "        ]",
        "      },",
        "    },",
        "    {",
        "      \"id\": \"T-20251214-111501-41d5-007\",",
        "      \"title\": \"SEC-007: Review task-manager skill permissions\",",
        "      \"status\": \"pending\",",
        "      \"priority\": \"low\",",
        "      \"category\": \"security\",",
        "      \"description\": \"Review and potentially restrict the task-manager skill's Write access.\\n\\nCurrent: allowed-tools: Read, Bash, Write\\nConcern: Write access could be used to modify arbitrary files\\n\\nOptions:\\n1. Remove Write, use Bash for file operations (more auditable)\\n2. Document what Write is used for and why it's necessary\\n3. Add path restrictions if skill system supports it\\n\\nEffort: 30 minutes\",",
        "      \"depends_on\": [],",
        "      \"effort\": \"small\","
      ],
      "change_type": "modify"
    },
    {
      "file": "tasks/2025-12-14_11-15-01_41d5.json",
      "function": null,
      "start_line": 139,
      "lines_added": [
        "      \"status\": \"completed\",",
        "      \"updated_at\": \"2025-12-14T11:28:39.474983\",",
        "      \"completed_at\": \"2025-12-14T11:28:39.474983\",",
        "      \"retrospective\": {",
        "        \"notes\": \"Implemented in commit 90b989f\"",
        "      }"
      ],
      "lines_removed": [
        "      \"status\": \"pending\",",
        "      \"updated_at\": null,",
        "      \"completed_at\": null,",
        "      \"retrospective\": null"
      ],
      "context_before": [
        "      \"context\": {",
        "        \"files\": [",
        "          \".claude/skills/task-manager/SKILL.md\"",
        "        ]",
        "      },",
        "      \"retrospective\": null",
        "    },",
        "    {",
        "      \"id\": \"T-20251214-111501-41d5-008\",",
        "      \"title\": \"SEC-008: Add deprecation warning for pickle format\","
      ],
      "context_after": [
        "      \"priority\": \"low\",",
        "      \"category\": \"security\",",
        "      \"description\": \"Add runtime deprecation warning when using pickle format.\\n\\nIn persistence.py save/load methods:\\n```python\\nimport warnings\\nif format == 'pickle':\\n    warnings.warn(\\n        \\\"Pickle format is deprecated due to security concerns. \\\"\\n        \\\"Use format='json' or format='protobuf' instead.\\\",\\n        DeprecationWarning,\\n        stacklevel=2\\n    )\\n```\\n\\nEffort: 2 hours\",",
        "      \"depends_on\": [],",
        "      \"effort\": \"small\",",
        "      \"created_at\": \"2025-12-14T11:15:01.281870\",",
        "      \"context\": {",
        "        \"files\": [",
        "          \"cortical/persistence.py\"",
        "        ]",
        "      },",
        "    },",
        "    {",
        "      \"id\": \"T-20251214-111501-41d5-009\",",
        "      \"title\": \"SEC-009: Add security-focused test suite\",",
        "      \"status\": \"pending\",",
        "      \"priority\": \"low\",",
        "      \"category\": \"security\",",
        "      \"description\": \"Create tests/security/ directory with security-focused tests.\\n\\nTest cases:\\n- Path traversal prevention in file operations\\n- Input validation on public API methods\\n- Pickle signature verification (if SEC-003 implemented)\\n- Large input handling (DoS prevention)\\n\\nEffort: 4 hours\",",
        "      \"depends_on\": [],",
        "      \"effort\": \"medium\","
      ],
      "change_type": "modify"
    }
  ],
  "hour_of_day": 11,
  "day_of_week": "Sunday",
  "seconds_since_last_commit": -94465,
  "is_merge": false,
  "is_initial": false,
  "parent_count": 1,
  "session_id": null,
  "related_chats": [],
  "ci_result": null,
  "reverted": false,
  "amended": false
}