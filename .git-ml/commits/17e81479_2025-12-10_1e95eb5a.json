{
  "hash": "17e81479e33063f07c99e43803e72ae2d2dd56bd",
  "message": "Add code review findings: critical bigram separator bugs",
  "author": "Claude",
  "timestamp": "2025-12-10 12:37:59 +0000",
  "branch": "claude/multi-index-design-DvifZ",
  "files_changed": [
    "TASK_LIST.md"
  ],
  "insertions": 143,
  "deletions": 0,
  "hunks": [
    {
      "file": "TASK_LIST.md",
      "function": "Added `get_expanded_query_terms()` helper function (~60 lines) that consolidates",
      "start_line": 1294,
      "lines_added": [
        "",
        "---",
        "",
        "## Critical Bug Fixes (2025-12-10)",
        "",
        "The following critical bugs were identified during code review and must be fixed:",
        "",
        "### 34. Fix Bigram Separator Mismatch in Analogy Completion",
        "",
        "**File:** `cortical/query.py`",
        "**Lines:** 1442-1468",
        "**Status:** [ ] Not Started",
        "**Priority:** Critical",
        "",
        "**Problem:**",
        "The `complete_analogy_simple()` function uses underscore separators for bigram lookup and parsing, but bigrams are stored with **space** separators (defined in `tokenizer.py:179`).",
        "",
        "**Affected Code:**",
        "```python",
        "# Line 1442-1443: WRONG - uses underscore",
        "ab_bigram = f\"{term_a}_{term_b}\"  # Creates \"neural_networks\"",
        "ba_bigram = f\"{term_b}_{term_a}\"",
        "",
        "# Line 1452: WRONG - splits by underscore",
        "parts = bigram.split('_')",
        "",
        "# But bigrams are stored with spaces (tokenizer.py:179):",
        "# ' '.join(tokens[i:i+n])  # Creates \"neural networks\"",
        "```",
        "",
        "**Impact:**",
        "- The bigram pattern matching strategy in `complete_analogy_simple()` is completely non-functional",
        "- `ab_col` and `ba_col` will always be `None` because \"neural_networks\" doesn't exist in the corpus",
        "- The `parts` split will never produce valid component extraction",
        "",
        "**Solution:**",
        "```python",
        "# Line 1442-1443: Should use space",
        "ab_bigram = f\"{term_a} {term_b}\"  # Correct: \"neural networks\"",
        "ba_bigram = f\"{term_b} {term_a}\"",
        "",
        "# Line 1452: Should split by space",
        "parts = bigram.split(' ')",
        "```",
        "",
        "**Files to Modify:**",
        "- `cortical/query.py` - Fix separator in lines 1442, 1443, 1452",
        "- `tests/test_processor.py` - Add tests for bigram-based analogy completion",
        "",
        "---",
        "",
        "### 35. Fix Bigram Separator Mismatch in Bigram Connections",
        "",
        "**File:** `cortical/analysis.py`",
        "**Line:** 927",
        "**Status:** [ ] Not Started",
        "**Priority:** Critical",
        "",
        "**Problem:**",
        "The `compute_bigram_connections()` function splits bigram content by underscore, but bigrams are stored with **space** separators.",
        "",
        "**Affected Code:**",
        "```python",
        "# Line 927: WRONG - splits by underscore",
        "for bigram in bigrams:",
        "    parts = bigram.content.split('_')",
        "    if len(parts) == 2:",
        "        left_index[parts[0]].append(bigram)",
        "        right_index[parts[1]].append(bigram)",
        "",
        "# But bigrams are stored with spaces:",
        "# \"neural networks\" not \"neural_networks\"",
        "```",
        "",
        "**Impact:**",
        "- `left_index` and `right_index` dictionaries are never populated",
        "- Component-sharing connections (e.g., \"neural networks\" ↔ \"neural processing\") are never created",
        "- Chain connections (e.g., \"machine learning\" ↔ \"learning algorithms\") are never created",
        "- Only document co-occurrence connections work correctly",
        "",
        "**Solution:**",
        "```python",
        "# Line 927: Should split by space",
        "parts = bigram.content.split(' ')",
        "```",
        "",
        "**Verification:**",
        "After fixing, the `compute_bigram_connections()` stats should show non-zero values for:",
        "- `component_connections`",
        "- `chain_connections`",
        "",
        "Currently these are always 0 due to the bug.",
        "",
        "**Files to Modify:**",
        "- `cortical/analysis.py` - Fix separator in line 927",
        "- `tests/test_analysis.py` - Add tests verifying component/chain connections work",
        "",
        "---",
        "",
        "## Code Quality Issues (2025-12-10)",
        "",
        "### 36. Inconsistent Bigram Separator Convention",
        "",
        "**Files:** Multiple",
        "**Status:** [ ] Future Enhancement",
        "**Priority:** Low",
        "",
        "**Observation:**",
        "The codebase has an inconsistent convention for bigram separators:",
        "- **Canonical format (tokenizer.py):** Space separator (`' '.join()`)",
        "- **Bug in query.py:** Underscore separator (`f\"{term_a}_{term_b}\"`)",
        "- **Bug in analysis.py:** Underscore separator (`split('_')`)",
        "",
        "**Recommendation:**",
        "1. Add a constant to define the canonical bigram separator",
        "2. Use the constant throughout the codebase",
        "3. Add documentation about the convention in CLAUDE.md",
        "",
        "**Example:**",
        "```python",
        "# In tokenizer.py or a constants module:",
        "BIGRAM_SEPARATOR = ' '",
        "",
        "# Usage:",
        "bigram = BIGRAM_SEPARATOR.join([term_a, term_b])",
        "parts = bigram.split(BIGRAM_SEPARATOR)",
        "```",
        "",
        "---",
        "",
        "## Updated Summary",
        "",
        "| Priority | Task | Status | Category |",
        "|----------|------|--------|----------|",
        "| **Critical** | **Fix bigram separator in analogy completion** | [ ] Not Started | **Bug Fix** |",
        "| **Critical** | **Fix bigram separator in bigram connections** | [ ] Not Started | **Bug Fix** |",
        "| Low | Inconsistent bigram separator convention | [ ] Future Enhancement | Code Quality |",
        "",
        "**Total Tests:** 337 (all passing)",
        "",
        "---",
        "",
        "*Updated from code review on 2025-12-10*"
      ],
      "lines_removed": [],
      "context_before": [
        "- Lateral connection expansion via `expand_query()`",
        "- Semantic relation expansion via `expand_query_semantic()`",
        "- Merging of expansion results with appropriate weighting",
        "- Configurable parameters: `max_expansions`, `semantic_discount`",
        "",
        "All 6 functions now use this helper, reducing code duplication by ~100 lines.",
        "",
        "---",
        "",
        "*Updated from code review on 2025-12-10*"
      ],
      "context_after": [],
      "change_type": "add"
    }
  ],
  "hour_of_day": 12,
  "day_of_week": "Wednesday",
  "seconds_since_last_commit": -436009,
  "is_merge": false,
  "is_initial": false,
  "parent_count": 1,
  "session_id": null,
  "related_chats": [],
  "ci_result": null,
  "reverted": false,
  "amended": false
}