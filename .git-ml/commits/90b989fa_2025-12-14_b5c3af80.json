{
  "hash": "90b989fa3c07d45a92c2fafecff0e03d1a71b511",
  "message": "security: Add pickle warnings, deprecation notices, and CI security scanning",
  "author": "Claude",
  "timestamp": "2025-12-14 11:27:43 +0000",
  "branch": "claude/multi-index-design-DvifZ",
  "files_changed": [
    ".github/workflows/ci.yml",
    "README.md",
    "cortical/persistence.py"
  ],
  "insertions": 109,
  "deletions": 0,
  "hunks": [
    {
      "file": "workflows/ci.yml b/.github/workflows/ci.yml",
      "function": "jobs:",
      "start_line": 361,
      "lines_added": [
        "",
        "  # ==========================================================================",
        "  # Security Scanning (runs in parallel with all other jobs)",
        "  # Static analysis and dependency scanning for security vulnerabilities",
        "  # ==========================================================================",
        "  security-scan:",
        "    name: \"üîê Security Scan\"",
        "    runs-on: ubuntu-latest",
        "    steps:",
        "    - uses: actions/checkout@v4",
        "",
        "    - name: Set up Python 3.11",
        "      uses: actions/setup-python@v5",
        "      with:",
        "        python-version: '3.11'",
        "",
        "    - name: Install security tools",
        "      run: |",
        "        python -m pip install --upgrade pip",
        "        pip install bandit pip-audit detect-secrets",
        "",
        "    - name: Run Bandit (SAST)",
        "      run: |",
        "        echo \"=== Running Bandit Static Analysis ===\"",
        "        # -ll = only show medium and higher severity issues",
        "        # -r = recursive",
        "        # Skip B101 (assert) as we use asserts for invariants in non-production code",
        "        bandit -r cortical/ -ll -s B101 -f txt || true",
        "        echo \"‚úÖ Bandit scan complete\"",
        "",
        "    - name: Run pip-audit (Dependency Scanning)",
        "      run: |",
        "        echo \"=== Running pip-audit Dependency Check ===\"",
        "        pip install -e \".[dev]\"",
        "        pip-audit --desc || echo \"‚ö†Ô∏è Review dependency vulnerabilities above\"",
        "",
        "    - name: Run detect-secrets (Secret Scanning)",
        "      run: |",
        "        echo \"=== Running detect-secrets ===\"",
        "        # Scan for accidentally committed secrets",
        "        detect-secrets scan --all-files --exclude-files '\\.git/.*' --exclude-files '.*\\.pkl' --exclude-files '.*\\.json' > .secrets-baseline.json || true",
        "        # Check if any high-entropy secrets were found (excluding test fixtures)",
        "        python -c \"",
        "import json",
        "with open('.secrets-baseline.json') as f:",
        "    data = json.load(f)",
        "    results = data.get('results', {})",
        "    real_secrets = {k: v for k, v in results.items() if not k.startswith('tests/')}",
        "    if real_secrets:",
        "        print('‚ö†Ô∏è Potential secrets found in:')",
        "        for file in real_secrets:",
        "            print(f'  - {file}')",
        "        print('Please review and ensure no real secrets are committed.')",
        "    else:",
        "        print('‚úÖ No secrets detected in source files')",
        "\""
      ],
      "lines_removed": [],
      "context_before": [
        "",
        "    - name: Set up Python 3.11",
        "      uses: actions/setup-python@v5",
        "      with:",
        "        python-version: '3.11'",
        "",
        "    - name: Run showcase",
        "      run: |",
        "        echo \"=== Running Showcase Demo ===\"",
        "        python showcase.py"
      ],
      "context_after": [],
      "change_type": "add"
    },
    {
      "file": "README.md",
      "function": "Detailed documentation is available in the `docs/` directory:",
      "start_line": 356,
      "lines_added": [
        "## Security Considerations",
        "",
        "### Pickle Deserialization Warning",
        "",
        "‚ö†Ô∏è **The default `.pkl` format uses Python's `pickle` module, which can execute arbitrary code during deserialization.**",
        "",
        "**Risk**: Loading a malicious `.pkl` file could result in remote code execution (RCE). Only load pickle files from sources you trust completely.",
        "",
        "**Recommendations**:",
        "",
        "1. **For untrusted sources**: Use the JSON state format instead:",
        "   ```python",
        "   from cortical.state_storage import StateLoader",
        "",
        "   # Save as JSON (safe to share)",
        "   StateLoader.save(processor, \"corpus_state.json\")",
        "",
        "   # Load from JSON (safe from untrusted sources)",
        "   processor = StateLoader.load(\"corpus_state.json\")",
        "   ```",
        "",
        "2. **For trusted sources**: Continue using pickle for faster serialization:",
        "   ```python",
        "   processor.save(\"corpus.pkl\")  # Fast, but only load files you trust",
        "   processor = CorticalTextProcessor.load(\"corpus.pkl\")",
        "   ```",
        "",
        "3. **For maximum security**: Never load pickle files from:",
        "   - Downloaded files from the internet",
        "   - User uploads",
        "   - Shared network locations with untrusted access",
        "   - Email attachments",
        "",
        "See [Python's pickle documentation](https://docs.python.org/3/library/pickle.html) for more details on pickle security.",
        ""
      ],
      "lines_removed": [],
      "context_before": [
        "| [docs/glossary.md](docs/glossary.md) | Terminology definitions |",
        "",
        "For AI agents, see also [docs/claude-usage.md](docs/claude-usage.md) and [CLAUDE.md](CLAUDE.md).",
        "",
        "## Running Tests",
        "",
        "```bash",
        "python -m unittest discover -s tests -v",
        "```",
        ""
      ],
      "context_after": [
        "## License",
        "",
        "MIT License"
      ],
      "change_type": "add"
    },
    {
      "file": "cortical/persistence.py",
      "function": "Save and load functionality for the cortical processor.",
      "start_line": 7,
      "lines_added": [
        "import warnings"
      ],
      "lines_removed": [],
      "context_before": [
        "Supports:",
        "- Pickle serialization for full state",
        "- JSON export for graph visualization",
        "- Incremental updates",
        "\"\"\"",
        "",
        "import pickle",
        "import json",
        "import os",
        "import logging"
      ],
      "context_after": [
        "from typing import Dict, Optional, Any",
        "",
        "from .layers import CorticalLayer, HierarchicalLayer",
        "from .minicolumn import Minicolumn",
        "from .proto import PROTOBUF_AVAILABLE, serialize_state, deserialize_state",
        "",
        "logger = logging.getLogger(__name__)",
        "",
        "",
        "def save_processor("
      ],
      "change_type": "add"
    },
    {
      "file": "cortical/persistence.py",
      "function": "def save_processor(",
      "start_line": 49,
      "lines_added": [
        "        # Emit deprecation warning for pickle format due to security concerns",
        "        warnings.warn(",
        "            \"Pickle format is deprecated due to security concerns (arbitrary code execution). \"",
        "            \"Consider using format='protobuf' or the StateLoader JSON format instead. \"",
        "            \"See README.md 'Security Considerations' for details.\",",
        "            DeprecationWarning,",
        "            stacklevel=2",
        "        )"
      ],
      "lines_removed": [],
      "context_before": [
        "        format: Serialization format ('pickle' or 'protobuf'). Default: 'pickle'",
        "",
        "    Raises:",
        "        ValueError: If format is not 'pickle' or 'protobuf'",
        "        ImportError: If format='protobuf' but protobuf package is not installed",
        "    \"\"\"",
        "    if format not in ['pickle', 'protobuf']:",
        "        raise ValueError(f\"Invalid format '{format}'. Must be 'pickle' or 'protobuf'.\")",
        "",
        "    if format == 'pickle':"
      ],
      "context_after": [
        "        # Original pickle serialization",
        "        state = {",
        "            'version': '2.2',",
        "            'layers': {},",
        "            'documents': documents,",
        "            'document_metadata': document_metadata or {},",
        "            'embeddings': embeddings or {},",
        "            'semantic_relations': semantic_relations or [],",
        "            'metadata': metadata or {}",
        "        }"
      ],
      "change_type": "add"
    },
    {
      "file": "cortical/persistence.py",
      "function": "def load_processor(",
      "start_line": 144,
      "lines_added": [
        "        # Emit deprecation warning for pickle format due to security concerns",
        "        warnings.warn(",
        "            \"Pickle format is deprecated due to security concerns (arbitrary code execution). \"",
        "            \"Only load pickle files from trusted sources. \"",
        "            \"Consider migrating to format='protobuf' or the StateLoader JSON format. \"",
        "            \"See README.md 'Security Considerations' for details.\",",
        "            DeprecationWarning,",
        "            stacklevel=2",
        "        )"
      ],
      "lines_removed": [],
      "context_before": [
        "                        # Default to pickle for unknown formats",
        "                        format = 'pickle'",
        "                except UnicodeDecodeError:",
        "                    # Binary content - assume pickle",
        "                    format = 'pickle'",
        "",
        "    if format not in ['pickle', 'protobuf']:",
        "        raise ValueError(f\"Invalid format '{format}'. Must be 'pickle' or 'protobuf'.\")",
        "",
        "    if format == 'pickle':"
      ],
      "context_after": [
        "        # Original pickle deserialization",
        "        with open(filepath, 'rb') as f:",
        "            state = pickle.load(f)",
        "",
        "        # Reconstruct layers",
        "        layers = {}",
        "        for level_value, layer_data in state.get('layers', {}).items():",
        "            # Validate layer value before creating enum",
        "            level_int = int(level_value)",
        "            if level_int not in [0, 1, 2, 3]:"
      ],
      "change_type": "add"
    }
  ],
  "hour_of_day": 11,
  "day_of_week": "Sunday",
  "seconds_since_last_commit": -94625,
  "is_merge": false,
  "is_initial": false,
  "parent_count": 1,
  "session_id": null,
  "related_chats": [],
  "ci_result": null,
  "reverted": false,
  "amended": false
}