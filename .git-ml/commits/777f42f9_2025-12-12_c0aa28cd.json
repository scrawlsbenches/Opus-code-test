{
  "hash": "777f42f9bcd520d752d356b8f55f88c948bd25a0",
  "message": "Update CLAUDE.md with new test organization documentation",
  "author": "Claude",
  "timestamp": "2025-12-12 13:52:52 +0000",
  "branch": "claude/multi-index-design-DvifZ",
  "files_changed": [
    "CLAUDE.md"
  ],
  "insertions": 91,
  "deletions": 11,
  "hunks": [
    {
      "file": "CLAUDE.md",
      "function": "cortical/",
      "start_line": 170,
      "lines_added": [
        "### Test Organization",
        "",
        "Tests are organized by category for clear CI diagnostics and efficient local development:",
        "",
        "```",
        "tests/",
        "├── smoke/                   # Quick sanity checks (<30s)",
        "├── unit/                    # Fast isolated tests",
        "├── integration/             # Component interaction tests",
        "├── performance/             # Timing tests (uses small synthetic corpus)",
        "├── regression/              # Bug-specific regression tests",
        "├── behavioral/              # User workflow quality tests",
        "├── fixtures/                # Shared test data (small_corpus, shared_processor)",
        "└── *.py                     # Legacy tests (still run for coverage)",
        "```",
        "",
        "**Test Categories:**",
        "",
        "| Category | Purpose | When to Use |",
        "|----------|---------|-------------|",
        "| `tests/smoke/` | Quick sanity checks | After major changes |",
        "| `tests/unit/` | Fast isolated tests | New function/class tests |",
        "| `tests/integration/` | Component interaction | Cross-module functionality |",
        "| `tests/performance/` | Timing regression | Performance-sensitive code |",
        "| `tests/regression/` | Bug-specific tests | After fixing a bug |",
        "| `tests/behavioral/` | User workflow quality | Search relevance, quality metrics |",
        "",
        "**Legacy Test Files** (still maintained for coverage):",
        "",
        "**Running Tests:**",
        "",
        "```bash",
        "# Quick feedback during development",
        "python scripts/run_tests.py smoke        # ~1s - sanity check",
        "python scripts/run_tests.py quick        # smoke + unit",
        "",
        "# Before committing",
        "python scripts/run_tests.py precommit    # smoke + unit + integration",
        "",
        "# Full test suite",
        "python -m unittest discover -s tests -v  # All tests with coverage",
        "",
        "# Specific category",
        "python -m pytest tests/performance/ -v   # Performance tests",
        "python -m pytest tests/regression/ -v    # Regression tests",
        "```"
      ],
      "lines_removed": [
        "### Test File Locations",
        "| **User workflows** | `tests/test_behavioral.py` (search relevance, performance, quality) |"
      ],
      "context_before": [
        "| Modify embeddings | `embeddings.py` - graph embedding methods |",
        "| Change gap detection | `gaps.py` - knowledge gap analysis |",
        "| Add fingerprinting | `fingerprint.py` - semantic fingerprints |",
        "| Modify chunk storage | `chunk_index.py` - git-friendly indexing |",
        "",
        "**Key data structures:**",
        "- `Minicolumn`: Core unit with `lateral_connections`, `typed_connections`, `feedforward_connections`, `feedback_connections`",
        "- `Edge`: Typed connection with `relation_type`, `weight`, `confidence`, `source`",
        "- `HierarchicalLayer`: Container with `minicolumns` dict and `_id_index` for O(1) lookups",
        ""
      ],
      "context_after": [
        "",
        "| When testing... | Add tests to... |",
        "|-----------------|-----------------|",
        "| Processor methods | `tests/test_processor.py` (most comprehensive) |",
        "| Query functions | `tests/test_query.py` |",
        "| Analysis algorithms | `tests/test_analysis.py` |",
        "| Semantic extraction | `tests/test_semantics.py` |",
        "| Persistence/save/load | `tests/test_persistence.py` |",
        "| Tokenization | `tests/test_tokenizer.py` |",
        "| Configuration | `tests/test_config.py` |",
        "| Layers | `tests/test_layers.py` |",
        "| Embeddings | `tests/test_embeddings.py` |",
        "| Gap detection | `tests/test_gaps.py` |",
        "| Fingerprinting | `tests/test_fingerprint.py` |",
        "| Code concepts | `tests/test_code_concepts.py` |",
        "| Chunk indexing | `tests/test_chunk_indexing.py` |",
        "| Incremental updates | `tests/test_incremental_indexing.py` |",
        "| Intent queries | `tests/test_intent_query.py` |",
        "",
        "---",
        "",
        "## Critical Knowledge",
        "",
        "### Performance Lessons Learned (2025-12-11)",
        "",
        "**Profile before optimizing.** During dog-fooding, `compute_all()` was hanging. Initial suspicion was Louvain clustering (the most complex algorithm). Profiling revealed the real culprits:",
        "",
        "| Phase | Before | After | Fix |"
      ],
      "change_type": "modify"
    },
    {
      "file": "CLAUDE.md",
      "function": "Key defaults to know:",
      "start_line": 475,
      "lines_added": [
        "The codebase supports both `unittest` (legacy) and `pytest` (new categorized tests):",
        "",
        "### Pytest Pattern (Recommended for New Tests)",
        "# tests/regression/test_regressions.py",
        "import pytest",
        "",
        "class TestYourBugFix:",
        "    \"\"\"",
        "    Task #XXX: Description of the bug that was fixed.",
        "    \"\"\"",
        "",
        "    def test_bug_is_fixed(self, small_processor):",
        "        \"\"\"Verify the specific bug is fixed.\"\"\"",
        "        # small_processor fixture provides pre-loaded corpus",
        "        result = small_processor.your_feature()",
        "        assert result is not None",
        "",
        "    def test_edge_case(self, fresh_processor):",
        "        \"\"\"Test with empty processor.\"\"\"",
        "        # fresh_processor fixture provides empty processor",
        "        result = fresh_processor.your_feature()",
        "        assert result == expected_value",
        "```",
        "",
        "### Unittest Pattern (Legacy Tests)",
        "",
        "```python",
        "# tests/test_processor.py",
        "### Available Fixtures (pytest)",
        "",
        "| Fixture | Scope | Description |",
        "|---------|-------|-------------|",
        "| `small_processor` | session | 25-doc synthetic corpus, pre-computed |",
        "| `shared_processor` | session | Full samples/ corpus (~125 docs) |",
        "| `fresh_processor` | function | Empty processor for isolated tests |",
        "| `small_corpus_docs` | function | Raw document dict |",
        "",
        "- Add regression test if fixing a bug"
      ],
      "lines_removed": [
        "Tests follow `unittest` conventions in `tests/` directory:",
        "",
        "    def test_feature_empty_corpus(self):",
        "        \"\"\"Test with empty processor.\"\"\"",
        "        empty = CorticalTextProcessor()",
        "        result = empty.your_feature()",
        "        self.assertEqual(result, expected_empty_value)"
      ],
      "context_before": [
        "   ```",
        "4. **Check for regressions** in related functionality",
        "5. **Dog-food the feature** - test with real usage (see [dogfooding-checklist.md](docs/dogfooding-checklist.md))",
        "6. **Document all findings** - add issues to TASK_LIST.md (see [code-of-ethics.md](docs/code-of-ethics.md))",
        "7. **Verify completion** - use [definition-of-done.md](docs/definition-of-done.md) checklist",
        "",
        "---",
        "",
        "## Testing Patterns",
        ""
      ],
      "context_after": [
        "",
        "```python",
        "class TestYourFeature(unittest.TestCase):",
        "    def setUp(self):",
        "        self.processor = CorticalTextProcessor()",
        "        self.processor.process_document(\"doc1\", \"Test content here.\")",
        "        self.processor.compute_all()",
        "",
        "    def test_feature_basic(self):",
        "        \"\"\"Test basic functionality.\"\"\"",
        "        result = self.processor.your_feature()",
        "        self.assertIsNotNone(result)",
        "```",
        "",
        "**Always test:**",
        "- Empty corpus case",
        "- Single document case",
        "- Multiple documents case",
        "- Edge cases specific to your feature",
        "",
        "---",
        "",
        "## Common Tasks",
        "",
        "### Adding a New Analysis Function",
        "",
        "1. Add function to `analysis.py` with proper signature:",
        "   ```python",
        "   def compute_your_analysis("
      ],
      "change_type": "modify"
    },
    {
      "file": "CLAUDE.md",
      "function": "python scripts/profile_full_analysis.py",
      "start_line": 700,
      "lines_added": [
        "| Run all tests | `python scripts/run_tests.py all` |",
        "| Run smoke tests | `python scripts/run_tests.py smoke` |",
        "| Run unit tests | `python scripts/run_tests.py unit` |",
        "| Run quick tests | `python scripts/run_tests.py quick` (smoke + unit) |",
        "| Run pre-commit | `python scripts/run_tests.py precommit` (smoke + unit + integration) |",
        "| Run performance | `python scripts/run_tests.py performance` (no coverage) |",
        "| Check coverage | `python -m coverage run --source=cortical -m pytest tests/ && python -m coverage report --include=\"cortical/*\"` |"
      ],
      "lines_removed": [
        "| Run tests | `python -m unittest discover -s tests -v` |",
        "| Check coverage | `python -m coverage run -m unittest discover -s tests && python -m coverage report --include=\"cortical/*\"` |"
      ],
      "context_before": [
        "| Build network | `processor.compute_all()` |",
        "| Search | `processor.find_documents_for_query(query)` |",
        "| Fast search | `processor.fast_find_documents(query)` |",
        "| Code search | `processor.expand_query_for_code(query)` |",
        "| Intent search | `processor.search_by_intent(\"where do we...\")` |",
        "| RAG passages | `processor.find_passages_for_query(query)` |",
        "| Fingerprint | `processor.get_fingerprint(text)` |",
        "| Compare | `processor.compare_fingerprints(fp1, fp2)` |",
        "| Save state | `processor.save(\"corpus.pkl\")` |",
        "| Load state | `processor = CorticalTextProcessor.load(\"corpus.pkl\")` |"
      ],
      "context_after": [
        "| Run showcase | `python showcase.py` |",
        "| Profile analysis | `python scripts/profile_full_analysis.py` |",
        "",
        "---",
        "",
        "## Dog-Fooding: Search the Codebase",
        "",
        "The Cortical Text Processor can index and search its own codebase, providing semantic search capabilities during development.",
        "",
        "### Quick Start"
      ],
      "change_type": "modify"
    }
  ],
  "hour_of_day": 13,
  "day_of_week": "Friday",
  "seconds_since_last_commit": -258716,
  "is_merge": false,
  "is_initial": false,
  "parent_count": 1,
  "session_id": null,
  "related_chats": [],
  "ci_result": null,
  "reverted": false,
  "amended": false
}