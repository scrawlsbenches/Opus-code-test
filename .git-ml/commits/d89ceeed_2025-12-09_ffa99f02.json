{
  "hash": "d89ceeedd5ed3c6b5d77070b7a1adc7185fefaac",
  "message": "Add TASK_LIST.md documenting required bug fixes",
  "author": "Claude",
  "timestamp": "2025-12-09 18:31:03 +0000",
  "branch": "claude/multi-index-design-DvifZ",
  "files_changed": [
    "TASK_LIST.md"
  ],
  "insertions": 231,
  "deletions": 0,
  "hunks": [
    {
      "file": "TASK_LIST.md",
      "function": null,
      "start_line": 0,
      "lines_added": [
        "# Task List: Required Bug Fixes",
        "",
        "This document tracks required bug fixes identified during the code review of the Cortical Text Processor.",
        "",
        "---",
        "",
        "## Critical Priority",
        "",
        "### 1. Fix Per-Document TF-IDF Calculation Bug",
        "",
        "**File:** `cortical/analysis.py`",
        "**Line:** 131",
        "**Status:** [ ] Not Started",
        "",
        "**Problem:**",
        "The per-document term frequency calculation is incorrect. The current code always returns 1:",
        "",
        "```python",
        "# Current (buggy) code",
        "for doc_id in col.document_ids:",
        "    doc_tf = sum(1 for d in [doc_id] if d in col.document_ids)  # Always = 1",
        "    col.tfidf_per_doc[doc_id] = math.log1p(doc_tf) * idf",
        "```",
        "",
        "The expression `sum(1 for d in [doc_id] if d in col.document_ids)` iterates over a single-element list `[doc_id]` and checks if that element is in `col.document_ids` - which is always true since we're iterating over `col.document_ids`.",
        "",
        "**Impact:**",
        "- Per-document TF-IDF scores are inaccurate",
        "- Document-specific ranking is affected",
        "- Query results may not be optimally ordered",
        "",
        "**Required Fix:**",
        "Track actual term occurrences per document during document processing, then use those counts here. This requires:",
        "1. Adding a `doc_occurrence_counts: Dict[str, int]` field to `Minicolumn`",
        "2. Incrementing the count in `processor.py:51` during tokenization",
        "3. Using the actual count in the TF-IDF calculation",
        "",
        "---",
        "",
        "## High Priority",
        "",
        "### 2. Add ID-to-Minicolumn Lookup Optimization",
        "",
        "**Files:** `cortical/layers.py`, `cortical/analysis.py`, `cortical/query.py`",
        "**Status:** [ ] Not Started",
        "",
        "**Problem:**",
        "Multiple O(n) linear searches occur throughout the codebase when looking up minicolumns by ID:",
        "",
        "```python",
        "# This inefficient pattern appears in multiple files",
        "for c in layer.minicolumns.values():",
        "    if c.id == neighbor_id:",
        "        # found it",
        "        break",
        "```",
        "",
        "**Locations:**",
        "- `analysis.py:57-59` (PageRank)",
        "- `analysis.py:176-179` (Activation propagation)",
        "- `analysis.py:247-250` (Label propagation)",
        "- `query.py:97-105` (Query expansion)",
        "- `query.py:276-281` (Spreading activation)",
        "- `query.py:314-318` (Related documents)",
        "",
        "**Impact:**",
        "- O(nÂ²) complexity in graph algorithms",
        "- Poor performance with large vocabularies",
        "",
        "**Required Fix:**",
        "Add a secondary index to `HierarchicalLayer`:",
        "",
        "```python",
        "class HierarchicalLayer:",
        "    def __init__(self, level: CorticalLayer):",
        "        self.level = level",
        "        self.minicolumns: Dict[str, Minicolumn] = {}",
        "        self._id_index: Dict[str, str] = {}  # id -> content mapping",
        "",
        "    def get_by_id(self, col_id: str) -> Optional[Minicolumn]:",
        "        \"\"\"O(1) lookup by minicolumn ID.\"\"\"",
        "        content = self._id_index.get(col_id)",
        "        return self.minicolumns.get(content) if content else None",
        "```",
        "",
        "---",
        "",
        "## Medium Priority",
        "",
        "### 3. Fix Type Annotation Errors",
        "",
        "**File:** `cortical/semantics.py`",
        "**Lines:** 153, 248",
        "**Status:** [ ] Not Started",
        "",
        "**Problem:**",
        "Type annotations use lowercase `any` instead of `typing.Any`:",
        "",
        "```python",
        "# Current (incorrect)",
        "def retrofit_connections(...) -> Dict[str, any]:",
        "",
        "# Should be",
        "def retrofit_connections(...) -> Dict[str, Any]:",
        "```",
        "",
        "**Required Fix:**",
        "1. Add `Any` to imports: `from typing import Dict, List, Tuple, Set, Optional, Any`",
        "2. Change `any` to `Any` on lines 153 and 248",
        "",
        "---",
        "",
        "### 4. Remove Unused Import",
        "",
        "**File:** `cortical/analysis.py`",
        "**Line:** 16",
        "**Status:** [ ] Not Started",
        "",
        "**Problem:**",
        "`Counter` is imported but never used:",
        "",
        "```python",
        "from collections import defaultdict, Counter  # Counter is unused",
        "```",
        "",
        "**Required Fix:**",
        "Remove `Counter` from the import statement.",
        "",
        "---",
        "",
        "### 5. Fix Unconditional Print in Export Function",
        "",
        "**File:** `cortical/persistence.py`",
        "**Lines:** 175-176",
        "**Status:** [ ] Not Started",
        "",
        "**Problem:**",
        "`export_graph_json` prints output unconditionally, ignoring any verbosity preferences:",
        "",
        "```python",
        "def export_graph_json(...) -> Dict:",
        "    # ... code ...",
        "    print(f\"Graph exported to {filepath}\")  # Always prints",
        "    print(f\"  - {len(nodes)} nodes, {len(edges)} edges\")",
        "```",
        "",
        "**Required Fix:**",
        "Add a `verbose: bool = True` parameter and wrap prints in a conditional:",
        "",
        "```python",
        "def export_graph_json(",
        "    filepath: str,",
        "    layers: Dict[CorticalLayer, HierarchicalLayer],",
        "    layer_filter: Optional[CorticalLayer] = None,",
        "    min_weight: float = 0.0,",
        "    max_nodes: int = 500,",
        "    verbose: bool = True  # Add this parameter",
        ") -> Dict:",
        "    # ... code ...",
        "    if verbose:",
        "        print(f\"Graph exported to {filepath}\")",
        "        print(f\"  - {len(nodes)} nodes, {len(edges)} edges\")",
        "```",
        "",
        "---",
        "",
        "## Low Priority",
        "",
        "### 6. Add Missing Test Coverage",
        "",
        "**Files:** `tests/test_embeddings.py` (new), `tests/test_semantics.py` (new)",
        "**Status:** [ ] Not Started",
        "",
        "**Problem:**",
        "The `embeddings.py` and `semantics.py` modules lack dedicated unit tests.",
        "",
        "**Required Tests:**",
        "- `test_embeddings.py`:",
        "  - `test_adjacency_embeddings`",
        "  - `test_random_walk_embeddings`",
        "  - `test_spectral_embeddings`",
        "  - `test_embedding_similarity`",
        "  - `test_find_similar_by_embedding`",
        "",
        "- `test_semantics.py`:",
        "  - `test_extract_corpus_semantics`",
        "  - `test_retrofit_connections`",
        "  - `test_retrofit_embeddings`",
        "  - `test_relation_type_weights`",
        "",
        "---",
        "",
        "### 7. Document Magic Numbers",
        "",
        "**File:** `cortical/gaps.py`",
        "**Lines:** 62, 76, 99",
        "**Status:** [ ] Not Started",
        "",
        "**Problem:**",
        "Threshold values are hardcoded without documentation:",
        "",
        "```python",
        "if avg_sim < 0.02:           # Line 62 - isolation threshold",
        "if col.tfidf > 0.005:        # Line 76 - weak topic threshold",
        "if 0.005 < sim < 0.03:       # Line 99 - bridge opportunity range",
        "```",
        "",
        "**Required Fix:**",
        "Either:",
        "1. Extract as module-level constants with docstrings, OR",
        "2. Make them configurable function parameters with documented defaults",
        "",
        "---",
        "",
        "## Summary",
        "",
        "| Priority | Task | Effort |",
        "|----------|------|--------|",
        "| Critical | Fix TF-IDF per-doc calculation | Medium |",
        "| High | Add ID lookup optimization | Medium |",
        "| Medium | Fix type annotations | Low |",
        "| Medium | Remove unused import | Low |",
        "| Medium | Add verbose parameter | Low |",
        "| Low | Add test coverage | Medium |",
        "| Low | Document magic numbers | Low |",
        "",
        "**Total Estimated Effort:** ~4-6 hours",
        "",
        "---",
        "",
        "*Generated from code review on 2025-12-09*"
      ],
      "lines_removed": [],
      "context_before": [],
      "context_after": [],
      "change_type": "add"
    }
  ],
  "hour_of_day": 18,
  "day_of_week": "Tuesday",
  "seconds_since_last_commit": -501225,
  "is_merge": false,
  "is_initial": false,
  "parent_count": 1,
  "session_id": null,
  "related_chats": [],
  "ci_result": null,
  "reverted": false,
  "amended": false
}