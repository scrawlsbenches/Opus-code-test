{
  "hash": "31c7e779dfacab09de7c0cd65ccd3b92ea63d16e",
  "message": "Update CLAUDE.md with collaborative working philosophy and lessons learned",
  "author": "Claude",
  "timestamp": "2025-12-11 22:54:54 +0000",
  "branch": "claude/multi-index-design-DvifZ",
  "files_changed": [
    "CLAUDE.md"
  ],
  "insertions": 90,
  "deletions": 12,
  "hunks": [
    {
      "file": "CLAUDE.md",
      "function": null,
      "start_line": 1,
      "lines_added": [
        "## Persona & Working Philosophy",
        "### Core Principles",
        "",
        "**Scientific Rigor First**",
        "- Verify claims with data, not assumptions",
        "- When something \"seems slow,\" profile it before optimizing",
        "- Be skeptical of intuitions—measure, then act",
        "",
        "**Understand Before Acting**",
        "- Read relevant code before proposing changes",
        "- Trace data flow through the system",
        "- Check TASK_LIST.md to avoid duplicate work",
        "",
        "**Deep Analysis Over Trial-and-Error**",
        "- When debugging, build a complete picture before running fixes",
        "- Profile bottlenecks systematically; the obvious culprit often isn't the real one",
        "- Document findings even when they contradict initial hypotheses",
        "",
        "**Test-Driven Confidence**",
        "- Maintain >89% code coverage before optimizations",
        "- Run the full test suite after every change",
        "- Write tests for the bug before writing the fix",
        "",
        "**Dog-Food Everything**",
        "- Use the system to test itself when possible",
        "- Real usage reveals issues that unit tests miss",
        "- Document all findings in TASK_LIST.md",
        "",
        "**Honest Assessment**",
        "- Acknowledge when something isn't working",
        "- Say \"I don't know\" when uncertain, then investigate",
        "- Correct course based on evidence, not pride",
        "",
        "When you see \"neural\" or \"cortical\" in this codebase, remember: these are metaphors for standard IR algorithms, not actual neural implementations.",
        "- **Louvain community detection** for concept clustering (`analysis.py`)"
      ],
      "lines_removed": [
        "## Persona",
        "Approach every task with **scientific rigor** - verify claims, check edge cases, and be skeptical of assumptions. When you see \"neural\" or \"cortical\" in this codebase, remember: these are metaphors for standard IR algorithms, not actual neural implementations.",
        "- **Label propagation** for concept clustering (`analysis.py`)"
      ],
      "context_before": [
        "# CLAUDE.md - Cortical Text Processor Development Guide",
        ""
      ],
      "context_after": [
        "",
        "You are a **senior computational neuroscience engineer** with deep expertise in:",
        "- Information retrieval algorithms (PageRank, TF-IDF, BM25)",
        "- Graph theory and network analysis",
        "- Natural language processing without ML dependencies",
        "- Biologically-inspired computing architectures",
        "- Python best practices and clean code principles",
        "",
        "",
        "---",
        "",
        "## Project Overview",
        "",
        "**Cortical Text Processor** is a zero-dependency Python library for hierarchical text analysis. It organizes text through 4 layers inspired by visual cortex organization:",
        "",
        "```",
        "Layer 0 (TOKENS)    → Individual words        [V1 analogy: edges]",
        "Layer 1 (BIGRAMS)   → Word pairs              [V2 analogy: patterns]",
        "Layer 2 (CONCEPTS)  → Semantic clusters       [V4 analogy: shapes]",
        "Layer 3 (DOCUMENTS) → Full documents          [IT analogy: objects]",
        "```",
        "",
        "**Core algorithms:**",
        "- **PageRank** for term importance (`analysis.py`)",
        "- **TF-IDF** for document relevance (`analysis.py`)",
        "- **Co-occurrence counting** for lateral connections (\"Hebbian learning\")",
        "- **Pattern-based relation extraction** for semantic relations (`semantics.py`)",
        "",
        "---",
        "",
        "## AI Agent Onboarding",
        "",
        "**New to this codebase?** Follow these steps to get oriented quickly:",
        "",
        "### Step 1: Generate AI Metadata (if missing)"
      ],
      "change_type": "modify"
    },
    {
      "file": "CLAUDE.md",
      "function": "cortical/",
      "start_line": 156,
      "lines_added": [
        "### Performance Lessons Learned (2025-12-11)",
        "",
        "**Profile before optimizing.** During dog-fooding, `compute_all()` was hanging. Initial suspicion was Louvain clustering (the most complex algorithm). Profiling revealed the real culprits:",
        "",
        "| Phase | Before | After | Fix |",
        "|-------|--------|-------|-----|",
        "| `bigram_connections` | 20.85s timeout | 10.79s | `max_bigrams_per_term=100`, `max_bigrams_per_doc=500` |",
        "| `semantics` | 30.05s timeout | 5.56s | `max_similarity_pairs=100000`, `min_context_keys=3` |",
        "| `louvain` | 2.2s | 2.2s | Not the bottleneck! |",
        "",
        "**Root cause:** O(n²) complexity from common terms like \"self\" creating millions of pairs.",
        "",
        "### Fixed Bugs",
        "",
        "**Bigram separators (2025-12-10):** Bigrams use space separators throughout (`\"neural networks\"`, not `\"neural_networks\"`).",
        "",
        "**Definition boost (2025-12-11):** Test files were ranking higher than real implementations. Fixed with `is_test_file()` detection and `test_file_penalty` parameter."
      ],
      "lines_removed": [
        "### Fixed Bugs (2025-12-10)",
        "Historical note: Bigram separator mismatch bugs have been **fixed**. Bigrams now correctly use space separators throughout the codebase (see `tokenizer.py:extract_ngrams` and `analysis.py:compute_bigram_connections`)."
      ],
      "context_before": [
        "| Fingerprinting | `tests/test_fingerprint.py` |",
        "| Code concepts | `tests/test_code_concepts.py` |",
        "| Chunk indexing | `tests/test_chunk_indexing.py` |",
        "| Incremental updates | `tests/test_incremental_indexing.py` |",
        "| Intent queries | `tests/test_intent_query.py` |",
        "",
        "---",
        "",
        "## Critical Knowledge",
        ""
      ],
      "context_after": [
        "",
        "### Important Implementation Details",
        "",
        "1. **Bigrams use SPACE separators** (from `tokenizer.py:319-332`):",
        "   ```python",
        "   ' '.join(tokens[i:i+n])  # \"neural networks\", not \"neural_networks\"",
        "   ```",
        "",
        "2. **Global `col.tfidf` is NOT per-document TF-IDF** - it uses total corpus occurrence count. Use `col.tfidf_per_doc[doc_id]` for true per-document TF-IDF.",
        ""
      ],
      "change_type": "modify"
    },
    {
      "file": "CLAUDE.md",
      "function": "if processor.is_stale(processor.COMP_PAGERANK):",
      "start_line": 246,
      "lines_added": [
        "4. **Check code coverage** - ensure >89% before optimizations:",
        "   ```bash",
        "   python -m coverage run -m unittest discover -s tests",
        "   python -m coverage report --include=\"cortical/*\"",
        "   ```",
        "5. **Trace data flow** - follow how data moves through layers",
        "",
        "### When Debugging Performance Issues",
        "",
        "1. **Profile first, optimize second:**",
        "   ```bash",
        "   python scripts/profile_full_analysis.py",
        "   ```",
        "2. **Question assumptions** - the obvious culprit often isn't the real one",
        "3. **Build a complete picture** before running fixes",
        "4. **Document findings** in TASK_LIST.md even if they contradict initial hypotheses",
        "2. **Check coverage hasn't dropped**:",
        "   ```bash",
        "   python -m coverage run -m unittest discover -s tests",
        "   python -m coverage report --include=\"cortical/*\"",
        "   ```",
        "3. **Run the showcase** to verify integration:",
        "4. **Check for regressions** in related functionality",
        "5. **Dog-food the feature** - test with real usage (see [dogfooding-checklist.md](docs/dogfooding-checklist.md))",
        "6. **Document all findings** - add issues to TASK_LIST.md (see [code-of-ethics.md](docs/code-of-ethics.md))",
        "7. **Verify completion** - use [definition-of-done.md](docs/definition-of-done.md) checklist"
      ],
      "lines_removed": [
        "4. **Trace data flow** - follow how data moves through layers",
        "2. **Run the showcase** to verify integration:",
        "3. **Check for regressions** in related functionality",
        "4. **Dog-food the feature** - test with real usage (see [dogfooding-checklist.md](docs/dogfooding-checklist.md))",
        "5. **Document all findings** - add issues to TASK_LIST.md (see [code-of-ethics.md](docs/code-of-ethics.md))",
        "6. **Verify completion** - use [definition-of-done.md](docs/definition-of-done.md) checklist"
      ],
      "context_before": [
        "## Development Workflow",
        "",
        "### Before Writing Code",
        "",
        "1. **Read the relevant module** - understand existing patterns",
        "2. **Check TASK_LIST.md** - see if work is already planned/done",
        "3. **Run tests first** to establish baseline:",
        "   ```bash",
        "   python -m unittest discover -s tests -v",
        "   ```"
      ],
      "context_after": [
        "",
        "### When Implementing Features",
        "",
        "1. **Follow existing patterns** - this codebase is consistent",
        "2. **Add type hints** - the codebase uses them extensively",
        "3. **Write docstrings** - Google style with Args/Returns sections",
        "4. **Update staleness tracking** if adding new computation:",
        "   ```python",
        "   # In processor.py, add constant:",
        "   COMP_YOUR_FEATURE = 'your_feature'",
        "   # Mark stale in _mark_all_stale()",
        "   # Mark fresh after computation",
        "   ```",
        "",
        "### After Writing Code",
        "",
        "1. **Run the full test suite**:",
        "   ```bash",
        "   python -m unittest discover -s tests -v",
        "   ```",
        "   ```bash",
        "   python showcase.py",
        "   ```",
        "",
        "---",
        "",
        "## Testing Patterns",
        "",
        "Tests follow `unittest` conventions in `tests/` directory:",
        "",
        "```python",
        "class TestYourFeature(unittest.TestCase):",
        "    def setUp(self):"
      ],
      "change_type": "modify"
    },
    {
      "file": "CLAUDE.md",
      "function": "def find_documents(",
      "start_line": 393,
      "lines_added": [
        "8. **Watch for O(n²) patterns** in loops over connections—use limits like `max_bigrams_per_term`"
      ],
      "lines_removed": [],
      "context_before": [
        "",
        "## Performance Considerations",
        "",
        "1. **Use `get_by_id()` for ID lookups** - O(1) vs O(n) iteration",
        "2. **Batch document additions** with `add_documents_batch()` for bulk imports",
        "3. **Use incremental updates** with `add_document_incremental()` for live systems",
        "4. **Cache query expansions** when processing multiple similar queries",
        "5. **Pre-compute chunks** in `find_passages_batch()` to avoid redundant work",
        "6. **Use `fast_find_documents()`** for ~2-3x faster search on large corpora",
        "7. **Pre-build index** with `build_search_index()` for fastest repeated queries"
      ],
      "context_after": [
        "",
        "---",
        "",
        "## Code Search Capabilities",
        "",
        "### Code-Aware Tokenization",
        "```python",
        "# Enable identifier splitting for code search",
        "tokenizer = Tokenizer(split_identifiers=True)",
        "tokens = tokenizer.tokenize(\"getUserCredentials\")"
      ],
      "change_type": "add"
    },
    {
      "file": "CLAUDE.md",
      "function": "for term, weight in sorted(expanded.items(), key=lambda x: -x[1]):",
      "start_line": 479,
      "lines_added": [
        "### Profiling Performance",
        "```bash",
        "# Profile full analysis phases with timeout detection",
        "python scripts/profile_full_analysis.py",
        "",
        "# This reveals which phases are slow and helps identify O(n²) bottlenecks",
        "```",
        "",
        "| Check coverage | `python -m coverage run -m unittest discover -s tests && python -m coverage report --include=\"cortical/*\"` |",
        "| Profile analysis | `python scripts/profile_full_analysis.py` |"
      ],
      "lines_removed": [],
      "context_before": [
        "    print(f\"  {term}: {weight:.3f}\")",
        "```",
        "",
        "### Checking Semantic Relations",
        "```python",
        "processor.extract_corpus_semantics()",
        "for t1, rel, t2, weight in processor.semantic_relations[:10]:",
        "    print(f\"{t1} --{rel}--> {t2} ({weight:.2f})\")",
        "```",
        ""
      ],
      "context_after": [
        "---",
        "",
        "## Quick Reference",
        "",
        "| Task | Command/Method |",
        "|------|----------------|",
        "| Process document | `processor.process_document(id, text)` |",
        "| Build network | `processor.compute_all()` |",
        "| Search | `processor.find_documents_for_query(query)` |",
        "| Fast search | `processor.fast_find_documents(query)` |",
        "| Code search | `processor.expand_query_for_code(query)` |",
        "| Intent search | `processor.search_by_intent(\"where do we...\")` |",
        "| RAG passages | `processor.find_passages_for_query(query)` |",
        "| Fingerprint | `processor.get_fingerprint(text)` |",
        "| Compare | `processor.compare_fingerprints(fp1, fp2)` |",
        "| Save state | `processor.save(\"corpus.pkl\")` |",
        "| Load state | `processor = CorticalTextProcessor.load(\"corpus.pkl\")` |",
        "| Run tests | `python -m unittest discover -s tests -v` |",
        "| Run showcase | `python showcase.py` |",
        "",
        "---",
        "",
        "## Dog-Fooding: Search the Codebase",
        "",
        "The Cortical Text Processor can index and search its own codebase, providing semantic search capabilities during development.",
        "",
        "### Quick Start",
        "",
        "```bash"
      ],
      "change_type": "add"
    },
    {
      "file": "CLAUDE.md",
      "function": "python scripts/index_codebase.py --status --use-chunks",
      "start_line": 660,
      "lines_added": [
        "*Remember: Measure before optimizing, test before committing, and document what you discover.*"
      ],
      "lines_removed": [
        "*Remember: Be skeptical, verify assumptions, and always run the tests.*"
      ],
      "context_before": [
        "**Process Documentation:**",
        "- **Getting Started**: `docs/quickstart.md` - 5-minute tutorial for newcomers",
        "- **Contributing**: `CONTRIBUTING.md` - how to contribute (fork, test, PR workflow)",
        "- **Ethics**: `docs/code-of-ethics.md` - documentation, testing, and completion standards",
        "- **Dog-fooding**: `docs/dogfooding-checklist.md` - checklist for testing with real usage",
        "- **Definition of Done**: `docs/definition-of-done.md` - when is a task truly complete?",
        "- **Task Archive**: `TASK_ARCHIVE.md` - completed tasks history",
        "",
        "---",
        ""
      ],
      "context_after": [],
      "change_type": "modify"
    }
  ],
  "hour_of_day": 22,
  "day_of_week": "Thursday",
  "seconds_since_last_commit": -312594,
  "is_merge": false,
  "is_initial": false,
  "parent_count": 1,
  "session_id": null,
  "related_chats": [],
  "ci_result": null,
  "reverted": false,
  "amended": false
}